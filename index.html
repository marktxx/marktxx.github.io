<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="never">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown编辑器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/common.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --header-bg: #f8f9fa;
            --border-color: #e0e0e0;
            --editor-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --dark-bg: #1e1e1e;
            --dark-text: #f0f0f0;
            --dark-border: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f7fa;
            overflow: hidden;
            color: #333;
        }

        body.dark-theme {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        /* 顶部菜单栏 */
        .header {
            background-color: var(--header-bg);
            padding: 12px 20px;
            box-shadow: var(--shadow);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-theme .header {
            background-color: #252526;
            color: var(--dark-text);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 24px;
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }

        .dark-theme .logo h1 {
            color: var(--dark-text);
        }

        .menu-bar {
            display: flex;
            gap: 15px;
        }

        .menu-item {
            position: relative;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 500;
            color: #555;
        }

        .dark-theme .menu-item {
            color: var(--dark-text);
        }

        .menu-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .dark-theme .menu-item:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }

        .menu-item i {
            margin-right: 8px;
        }

        .divider {
            width: 1px;
            background-color: var(--border-color);
            margin: 0 10px;
        }

        .dark-theme .divider {
            background-color: var(--dark-border);
        }

        /* 主内容区域 */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 左侧文件列表 */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: white;
            transition: all 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .dark-theme .sidebar {
            background-color: #252526;
        }

        .sidebar.collapsed {
            width: 50px;
        }

        .sidebar-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-theme .sidebar-header {
            border-bottom: 1px solid var(--dark-border);
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            min-width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-list {
            flex: 1;
            padding: 10px 0;
        }

        .file-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .file-item:hover {
            background-color: var(--sidebar-hover);
        }

        .file-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .file-item i {
            margin-right: 10px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-time {
            font-size: 12px;
            opacity: 0.8;
            margin-left: 10px;
            white-space: nowrap;
        }

        .file-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            padding: 2px;
        }

        .file-item:hover .file-actions {
            opacity: 1;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
        }

        .file-action-btn:hover {
            color: white;
        }

        .add-file-btn {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: color 0.2s;
        }

        .add-file-btn:hover {
            color: white;
        }

        .add-file-btn i {
            margin-right: 10px;
            flex-shrink: 0;
        }

        .add-file-btn span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .file-name,
        .sidebar.collapsed .file-time,
        .sidebar.collapsed .add-file-btn span {
            display: none;
        }

        .sidebar.collapsed .file-item {
            padding: 15px;
            justify-content: center;
        }

        .sidebar.collapsed .file-item i {
            margin-right: 0;
            font-size: 18px;
        }

        .sidebar.collapsed .add-file-btn {
            justify-content: center;
            padding: 15px;
        }

        .sidebar.collapsed .add-file-btn i {
            margin-right: 0;
            font-size: 18px;
        }

        .sidebar.collapsed .file-actions {
            display: none;
        }

        /* 编辑区域 */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--editor-bg);
            overflow: hidden;
        }

        .dark-theme .editor-container {
            background-color: #1e1e1e;
        }

        .editor-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-theme .editor-header {
            border-bottom-color: var(--dark-border);
        }

        .editor-title {
            font-size: 16px;
            font-weight: 500;
        }

        .dark-theme .editor-title {
            color: var(--dark-text);
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .editor-btn {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .editor-btn:hover {
            background-color: var(--secondary-color);
        }

        .editor-btn.secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .dark-theme .editor-btn.secondary {
            background-color: #444;
            color: var(--dark-text);
        }

        .editor-btn.secondary:hover {
            background-color: #d0d0d0;
        }

        .dark-theme .editor-btn.secondary:hover {
            background-color: #555;
        }

        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .editor-mode {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
        }

        .editor-mode.active {
            display: block;
        }

        .split-view {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .split-view .editor-mode {
            width: 50%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }

        #editor {
            width: 100%;
            height: 100%;
            min-height: 300px;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            padding: 10px;
            background-color: transparent;
            color: #333;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .dark-theme #editor {
            color: var(--dark-text);
            background-color: #1e1e1e;
        }

        #preview {
            padding: 20px;
            line-height: 1.6;
        }

        .dark-theme #preview {
            color: var(--dark-text);
        }

        /* 状态栏 */
        .status-bar {
            padding: 8px 20px;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }

        .dark-theme .status-bar {
            background-color: #252526;
            border-top-color: var(--dark-border);
            color: #aaa;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status i {
            font-size: 14px;
        }

        .sync-status.synced {
            color: var(--success-color);
        }

        .sync-status.error {
            color: var(--error-color);
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .dark-theme .modal-content {
            background-color: #252526;
            color: var(--dark-text);
        }

        .modal-header {
            padding: 15px 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-theme .modal-header {
            background-color: #2d2d2d;
            border-bottom-color: var(--dark-border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .dark-theme .modal-title {
            color: var(--dark-text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }

        .dark-theme .modal-close {
            color: #aaa;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .dark-theme .modal-body {
            background-color: #1e1e1e;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .dark-theme .form-label {
            color: var(--dark-text);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }

        .dark-theme .form-input {
            background-color: #333;
            border-color: #444;
            color: var(--dark-text);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }

        .dark-theme .form-select {
            background-color: #333;
            border-color: #444;
            color: var(--dark-text);
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            min-height: 150px;
            resize: vertical;
            background-color: white;
        }

        .dark-theme .form-textarea {
            background-color: #333;
            border-color: #444;
            color: var(--dark-text);
        }

        .repo-list {
            margin-bottom: 15px;
        }

        .repo-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .dark-theme .repo-item {
            background-color: #333;
            border-color: #444;
        }

        .repo-item input[type="radio"] {
            margin-right: 10px;
        }

        .repo-item .repo-url {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .repo-item .repo-actions {
            display: flex;
            gap: 5px;
        }

        .repo-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #777;
        }

        .dark-theme .repo-action-btn {
            color: #aaa;
        }

        .repo-action-btn:hover {
            color: var(--primary-color);
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .dark-theme .tab-container {
            border-bottom-color: var(--dark-border);
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .dark-theme .tab.active {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .dark-theme .modal-footer {
            background-color: #2d2d2d;
            border-top-color: var(--dark-border);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 60px;
                bottom: 0;
                z-index: 5;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .toggle-btn {
                display: block;
            }

            .menu-bar {
                gap: 8px;
            }

            .menu-item {
                padding: 6px 8px;
                font-size: 14px;
            }

            .menu-item span {
                display: none;
            }

            .menu-item i {
                margin-right: 0;
                font-size: 18px;
            }

            .editor-btn span {
                display: none;
            }

            .editor-btn i {
                margin-right: 0;
            }

            /* 移动端分屏模式改为上下布局 */
            .split-view {
                flex-direction: column;
            }

            .split-view .editor-mode {
                width: 100%;
                height: 50%;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 18px;
            }

            .editor-title {
                font-size: 14px;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .status-bar {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* Markdown样式 */
        #preview h1,
        #preview h2,
        #preview h3 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        #preview h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .dark-theme #preview h1 {
            border-bottom-color: #444;
        }

        #preview h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .dark-theme #preview h2 {
            border-bottom-color: #444;
        }

        #preview p {
            margin-bottom: 16px;
        }

        #preview a {
            color: var(--primary-color);
            text-decoration: none;
        }

        #preview a:hover {
            text-decoration: underline;
        }

        #preview code {
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-family: monospace;
        }

        .dark-theme #preview code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #preview pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            margin-bottom: 16px;
        }

        .dark-theme #preview pre {
            background-color: #2d2d2d;
        }

        #preview blockquote {
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
            margin: 0 0 16px 0;
        }

        .dark-theme #preview blockquote {
            color: #aaa;
            border-left-color: #555;
        }

        #preview ul,
        #preview ol {
            margin-bottom: 16px;
            padding-left: 2em;
        }

        #preview li {
            margin-bottom: 0.5em;
        }

        #preview table {
            border-collapse: collapse;
            margin-bottom: 16px;
            width: 100%;
        }

        #preview th,
        #preview td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }

        .dark-theme #preview th,
        .dark-theme #preview td {
            border-color: #444;
        }

        #preview th {
            background-color: #f6f8fa;
            font-weight: 600;
        }

        .dark-theme #preview th {
            background-color: #333;
        }

        #preview img {
            max-width: 100%;
        }
    </style>
</head>

<body>



    <!-- 顶部菜单栏 -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-file-alt" id="logo"></i>
            <h1>Markdown</h1>
        </div>
        <div class="menu-bar">
            <div class="menu-item" id="viewMenu">
                <i class="fas fa-eye"></i>
                <span>视图</span>
            </div>
            <div class="menu-item" id="prefMenu">
                <i class="fas fa-cog"></i>
                <span>偏好设置</span>
            </div>
            <div class="menu-item" id="historyMenu">
                <i class="fas fa-history"></i>
                <span>历史版本</span>
            </div>
            <div class="menu-item" id="storageMenu">
                <i class="fas fa-database"></i>
                <span>存储设置</span>
            </div>
            <div class="menu-item" id="dataMenu">
                <i class="fas fa-file-import"></i>
                <span>导入/导出</span>
            </div>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 左侧文件列表 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">文件列表</div>
                <button class="toggle-btn" id="sidebarToggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="file-list" id="fileList">
                <!-- 文件列表将通过JS动态生成 -->
            </div>
            <div class="add-file-btn" id="addFileBtn">
                <i class="fas fa-plus-circle"></i>
                <span>新建文件</span>
            </div>
        </div>

        <!-- 编辑区域 -->
        <div class="editor-container">
            <div class="editor-header">
                <div class="editor-title" id="editorTitle">未命名.md</div>
                <div class="editor-actions">
                    <button class="editor-btn" id="insertBtn">
                        <i class="fas fa-plus"></i>
                        <span>插入</span>
                    </button>
                    <button class="editor-btn" id="syncBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>同步</span>
                    </button>
                </div>
            </div>
            <div class="editor-content">
                <div class="editor-mode active" id="editMode">
                    <textarea id="editor" placeholder="开始输入Markdown内容..."></textarea>
                </div>
                <div class="editor-mode" id="previewMode">
                    <div id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="word-count">字数: <span id="wordCount">0</span></div>
        <div id="storageStatus">存储方式: <span id="storageType">本地存储</span></div>
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-circle"></i> <span>未同步</span>
        </div>
    </div>
    <!-- 视图设置模态框 -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">视图设置</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">编辑模式</label>
                    <div>
                        <input type="radio" id="editOnly" name="viewMode" value="edit" checked>
                        <label for="editOnly">仅编辑</label>
                    </div>
                    <div>
                        <input type="radio" id="previewOnly" name="viewMode" value="preview">
                        <label for="previewOnly">仅预览</label>
                    </div>
                    <div>
                        <input type="radio" id="splitView" name="viewMode" value="split">
                        <label for="splitView">分屏显示</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="cancelView">取消</button>
                <button class="editor-btn" id="saveView">保存设置</button>
            </div>
        </div>
    </div>
    <!-- 插入模态框 -->
    <div class="modal" id="insertModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">插入内容</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab active" data-tab="image">图片</div>
                    <div class="tab" data-tab="video">视频</div>
                    <div class="tab" data-tab="file">文件</div>
                    <div class="tab" data-tab="other">其他</div>
                </div>

                <div class="tab-content active" id="imageTab">
                    <div class="form-group">
                        <label class="form-label">图片URL</label>
                        <input type="text" class="form-input" id="imageUrl" placeholder="输入图片URL">
                    </div>
                    <div class="form-group">
                        <label class="form-label">或上传图片</label>
                        <input type="file" class="form-input" id="imageUpload" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label class="form-label">替代文本</label>
                        <input type="text" class="form-input" id="imageAlt" placeholder="图片描述">
                    </div>
                    <button class="editor-btn" id="insertImageBtn">插入图片</button>
                </div>

                <div class="tab-content" id="videoTab">
                    <div class="form-group">
                        <label class="form-label">视频URL</label>
                        <input type="text" class="form-input" id="videoUrl" placeholder="输入视频URL">
                    </div>
                    <div class="form-group">
                        <label class="form-label">视频平台</label>
                        <select class="form-select" id="videoPlatform">
                            <option value="youtube">YouTube</option>
                            <option value="vimeo">Vimeo</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <button class="editor-btn" id="insertVideoBtn">插入视频</button>
                </div>

                <div class="tab-content" id="fileTab">
                    <div class="form-group">
                        <label class="form-label">文件URL</label>
                        <input type="text" class="form-input" id="fileUrl" placeholder="输入文件URL">
                    </div>
                    <div class="form-group">
                        <label class="form-label">或上传文件</label>
                        <input type="file" class="form-input" id="fileUpload">
                    </div>
                    <div class="form-group">
                        <label class="form-label">链接文本</label>
                        <input type="text" class="form-input" id="fileText" placeholder="链接显示文本">
                    </div>
                    <button class="editor-btn" id="insertFileBtn">插入文件链接</button>
                </div>

                <div class="tab-content" id="otherTab">
                    <div class="form-group">
                        <label class="form-label">插入内容类型</label>
                        <select class="form-select" id="otherType">
                            <option value="table">表格</option>
                            <option value="code">代码块</option>
                            <option value="quote">引用</option>
                            <option value="divider">分隔线</option>
                        </select>
                    </div>
                    <button class="editor-btn" id="insertOtherBtn">插入</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 偏好设置模态框 -->
    <div class="modal" id="prefModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">偏好设置</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab active" data-tab="theme">主题</div>
                    <div class="tab" data-tab="editor">编辑器</div>
                    <div class="tab" data-tab="importExport">配置导入/导出</div>
                    <div class="tab" data-tab="template">模板设置</div>
                    <div class="tab" data-tab="imageHost">图床</div>
                </div>

                <div class="tab-content active" id="themeTab">
                    <div class="form-group">
                        <label class="form-label">主题设置</label>
                        <div>
                            <input type="radio" id="lightTheme" name="theme" value="light" checked>
                            <label for="lightTheme">亮色主题</label>
                        </div>
                        <div>
                            <input type="radio" id="darkTheme" name="theme" value="dark">
                            <label for="darkTheme">暗色主题</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">编辑器字体大小</label>
                        <input type="range" min="12" max="24" value="16" class="form-input" id="fontSize">
                        <div id="fontSizeValue">16px</div>
                    </div>
                </div>

                <div class="tab-content" id="editorTab">
                    <div class="form-group">
                        <label class="form-label">编辑器设置</label>
                        <div>
                            <input type="checkbox" id="lineNumbers" checked>
                            <label for="lineNumbers">显示行号</label>
                        </div>
                        <div>
                            <input type="checkbox" id="autoIndent" checked>
                            <label for="autoIndent">自动缩进</label>
                        </div>
                        <div>
                            <input type="checkbox" id="wordWrap" checked>
                            <label for="wordWrap">自动换行</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tab键宽度</label>
                        <input type="range" min="2" max="8" value="4" class="form-input" id="tabSize">
                        <div id="tabSizeValue">4个空格</div>
                    </div>
                </div>

                <div class="tab-content" id="importExportTab">
                    <div class="form-group">
                        <label class="form-label">导入配置</label>
                        <input type="file" id="configImport" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">导出配置</label>
                        <button class="editor-btn secondary" id="exportConfigBtn">导出配置</button>
                    </div>

                </div>

                <div class="tab-content" id="templateTab">
                    <div class="form-group">
                        <label class="form-label">模板管理</label>
                        <div id="templateList">
                            <!-- 模板列表将通过JS动态生成 -->
                        </div>
                        <button class="editor-btn secondary" id="addTemplateBtn">
                            <i class="fas fa-plus"></i> 添加模板
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">模板内容</label>
                        <textarea class="form-textarea" id="templateContent" placeholder="输入模板内容..."></textarea>
                        <p class="form-hint">支持变量：<br />
                            {{date}} - 当前日期<br />
                            {{time}} - 当前时间<br />
                            {{datetime}} - 当前日期和时间<br />
                            {{filename}} - 文档名称<br />
                            {{year}} - 年<br />
                            {{month}} - 月<br />
                            {{day}} - 日<br />
                        </p>
                    </div>
                </div>

                <!-- 图床设置内容 -->
                <div class="tab-content" id="imageHostTab">
                    <div class="form-group">
                        <label class="form-label">选择图床服务</label>
                        <select class="form-select" id="imageHostService">
                            <option value="github">GitHub</option>
                            <option value="gitee">Gitee</option>
                            <option value="custom">自定义</option>
                        </select>
                        <button class="editor-btn secondary" id="setDefaultImageHostBtn" style="margin-top: 10px;">
                            <i class="fas fa-star"></i> 设为默认图床
                        </button>
                    </div>

                    <div class="form-group" id="githubConfig">
                        <label class="form-label">GitHub配置</label>
                        <div class="form-group">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-input" placeholder="用户名" id="githubUsername">
                        </div>
                        <div class="form-group">
                            <label class="form-label">仓库名</label>
                            <input type="text" class="form-input" placeholder="仓库名" id="githubRepo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分支</label>
                            <input type="text" class="form-input" placeholder="分支" value="master" id="githubBranch">
                        </div>
                        <div class="form-group">
                            <label class="form-label">目录路径</label>
                            <input type="text" class="form-input" placeholder="目录路径" value="img" id="githubPath">
                        </div>
                        <div class="form-group">
                            <label class="form-label">访问令牌</label>
                            <input type="password" class="form-input" placeholder="访问令牌" id="githubToken">
                        </div>
                        <div class="form-group">
                            <label class="form-label">自定义域名</label>
                            <input type="text" class="form-input" placeholder="https://xxxx" id="githubDomain">
                        </div>
                    </div>

                    <div class="form-group" id="giteeConfig" style="display: none;">
                        <label class="form-label">Gitee配置</label>
                        <div class="form-group">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-input" placeholder="用户名" id="giteeUsername">
                        </div>
                        <div class="form-group">
                            <label class="form-label">仓库名</label>
                            <input type="text" class="form-input" placeholder="仓库名" id="giteeRepo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分支</label>
                            <input type="text" class="form-input" placeholder="分支" value="master" id="giteeBranch">
                        </div>
                        <div class="form-group">
                            <label class="form-label">目录路径</label>
                            <input type="text" class="form-input" placeholder="目录路径" value="img" id="giteePath">
                        </div>
                        <div class="form-group">
                            <label class="form-label">访问令牌</label>
                            <input type="password" class="form-input" placeholder="访问令牌" id="giteeToken">
                        </div>
                        <div class="form-group">
                            <label class="form-label">自定义域名</label>
                            <input type="text" class="form-input" placeholder="https://xxxx" id="giteeDomain">
                        </div>
                    </div>

                    <div class="form-group" id="customConfig" style="display: none;">
                        <label class="form-label">自定义图床配置</label>
                        <input type="text" class="form-input" placeholder="API地址" id="customApiUrl">
                        <input type="text" class="form-input" placeholder="上传路径" id="customUploadPath">
                        <input type="password" class="form-input" placeholder="API密钥" id="customApiKey">
                        <input type="text" class="form-input" placeholder="自定义域名" id="customDomain">
                    </div>

                    <div class="form-group">
                        <button class="editor-btn" id="testImageHostBtn">测试连接</button>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="cancelPref">取消</button>
                <button class="editor-btn" id="savePref">保存设置</button>
            </div>
        </div>
    </div>


    <!-- 修改历史版本模态框结构 -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">历史版本</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab active" data-tab="local">本地历史</div>
                    <div class="tab" data-tab="remote">远程仓库历史</div>
                </div>

                <!-- 本地历史标签页 -->
                <div class="tab-content active" id="localTab">
                    <div class="form-group">
                        <label class="form-label">选择文件</label>
                        <select class="form-select" id="localHistoryFileSelect">
                            <!-- 文件选项将通过JS动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">历史版本</label>
                        <div id="localHistoryList">
                            <!-- 本地历史版本列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 远程仓库历史标签页 -->
                <div class="tab-content" id="remoteTab">
                    <div class="form-group">
                        <label class="form-label">选择仓库</label>
                        <select class="form-select" id="remoteHistoryRepoSelect">
                            <!-- 仓库选项将通过JS动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">历史版本</label>
                        <div id="remoteHistoryList">
                            <!-- 远程历史版本列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="closeHistory">关闭</button>
                <button class="editor-btn" id="restoreVersion">恢复此版本</button>
            </div>
        </div>
    </div>
    <!-- 存储设置模态框 -->
    <div class="modal" id="storageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">存储设置</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab active" data-tab="local">本地存储</div>
                    <div class="tab" data-tab="git">Git存储</div>
                    <div class="tab" data-tab="multigit">多点Git存储</div>
                    <div class="tab" data-tab="webdav">WebDAV</div>
                </div>

                <div class="tab-content active" id="localTab">
                    <div class="form-group">
                        <label class="form-label">自动保存</label>
                        <div>
                            <input type="checkbox" id="autoSave" checked>
                            <label for="autoSave">启用自动保存</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">保存间隔（秒）</label>
                        <input type="number" min="5" max="300" value="30" class="form-input" id="saveInterval">
                    </div>
                </div>

                <div class="tab-content" id="gitTab">
                    <div class="form-group">
                        <label class="form-label">仓库URL</label>
                        <input type="text" class="form-input" id="gitRepoUrl"
                            placeholder="https://github.com/user/repo.git">
                    </div>
                    <div class="form-group">
                        <label class="form-label">分支</label>
                        <input type="text" class="form-input" id="gitBranch" value="master">
                    </div>
                    <div class="form-group">
                        <label class="form-label">访问令牌</label>
                        <input type="password" class="form-input" id="gitToken" placeholder="输入访问令牌">
                    </div>
                    <div class="form-group">
                        <label class="form-label">自动同步</label>
                        <div>
                            <input type="checkbox" id="gitAutoSync" checked>
                            <label for="gitAutoSync">保存时自动同步</label>
                        </div>
                    </div>
                </div>

                <!-- 多点Git存储配置 -->
                <div class="tab-content" id="multigitTab">
                    <div class="form-group">
                        <label class="form-label">Git仓库配置</label>
                        <div class="repo-list" id="repoList">
                            <!-- 仓库配置项将通过JS动态生成 -->
                        </div>
                        <button class="editor-btn secondary" id="addRepoBtn" style="width: auto;">
                            <i class="fas fa-plus"></i> 添加仓库
                        </button>
                    </div>


                    <div class="form-group">
                        <label class="form-label">自动同步</label>
                        <div>
                            <input type="checkbox" id="multiAutoSync" checked>
                            <label for="multiAutoSync">保存文件时自动同步</label>
                        </div>
                    </div>
                </div>


                <div class="tab-content" id="webdavTab">
                    <div class="form-group">
                        <label class="form-label">服务器URL</label>
                        <input type="text" class="form-input" id="webdavUrl" placeholder="https://example.com/dav">
                    </div>
                    <div class="form-group">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-input" id="webdavUser" placeholder="用户名">
                    </div>
                    <div class="form-group">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-input" id="webdavPass" placeholder="密码">
                    </div>
                    <div class="form-group">
                        <label class="form-label">远程路径</label>
                        <input type="text" class="form-input" id="webdavPath" value="/markdown">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="cancelStorage">取消</button>
                <button class="editor-btn" id="saveStorage">保存设置</button>
            </div>
        </div>
    </div>


    <!-- 仓库配置项模板 -->
    <template id="gitRepoItemTemplate">
        <div class="git-repo-item"
            style="border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 15px; position: relative; background-color: var(--editor-bg);">

            <button type="button" class="remove-repo-btn"
                style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--error-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>

            <!-- 主仓库选择按钮 -->
            <div class="primary-repo-select" style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="radio" name="primaryRepo" class="primary-repo-radio" style="margin-right: 8px;">
                <label style="font-weight: 500; color: var(--primary-color);">主仓库</label>
            </div>

            <div class="form-group">
                <label class="form-label">仓库名称</label>
                <input type="text" class="repo-name form-input" placeholder="仓库描述（例如：主仓库）">
            </div>

            <!-- 仓库类型选择 -->
            <div class="form-group">
                <label class="form-label">仓库类型</label>
                <select class="repo-type form-select">
                    <option value="github">GitHub</option>
                    <option value="gitee">Gitee</option>
                    <option value="gitea">Gitea</option>
                    <option value="gitlab">GitLab</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">访问令牌</label>
                <input type="password" class="repo-token form-input" placeholder="输入访问令牌">
            </div>

            <div class="form-group">
                <label class="form-label">仓库路径</label>
                <input type="text" class="repo-path form-input" placeholder="用户名/仓库名">
            </div>

            <div class="form-group">
                <label class="form-label">分支</label>
                <input type="text" class="repo-path form-input" placeholder="master" value="master">
            </div>

            <!-- 新增加密存储选项 -->
            <div class="form-group">
                <label class="form-label">加密存储</label>
                <select class="encrypt-option form-select">
                    <option value="yes" selected>是</option>
                    <option value="no">否</option>
                </select>
            </div>

            <!-- Gitea需要额外配置服务器地址 -->
            <div class="form-group gitea-server" style="display: none;">
                <label class="form-label">Gitea 服务器地址</label>
                <input type="url" class="gitea-url form-input" placeholder="https://gitea.example.com">
            </div>

            <button type="button" class="remove-repo-btn"
                style="width: auto; padding: 5px 10px; background-color: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-trash"></i> 移除
            </button>
        </div>
    </template>
    <!-- 历史版本模态框 -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">历史版本</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择仓库</label>
                    <select id="historyRepoSelect" class="form-select">
                        <!-- 仓库选项将通过JS动态生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">历史版本</label>
                    <div id="historyList" style="max-height: 300px; overflow-y: auto;">
                        <!-- 历史版本列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="closeHistory">关闭</button>
            </div>
        </div>
    </div>
    <!-- 提交信息模态框 -->
    <div class="modal" id="commitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">提交信息</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">提交信息</label>
                    <textarea id="commitMessage" class="form-textarea" placeholder="输入提交信息..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">仓库选择</label>
                    <select id="commitRepoSelect" class="form-select">
                        <!-- 仓库选项将通过JS动态生成 -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="cancelCommit">取消</button>
                <button class="editor-btn" id="confirmCommit">提交</button>
            </div>
        </div>
    </div>
    <!-- 确认回退模态框 -->
    <div class="modal" id="restoreConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">确认回退</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>确定要回退到此版本吗？当前未保存的更改将会丢失。</p>
            </div>
            <div class="modal-footer">
                <button class="editor-btn secondary" id="cancelRestore">取消</button>
                <button class="editor-btn" id="confirmRestore">确认回退</button>
            </div>
        </div>
    </div>
    <!-- 数据导入导出模态框 -->
    <div class="modal" id="dataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">数据导入/导出</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab active" data-tab="import">导入数据</div>
                    <div class="tab" data-tab="export">导出数据</div>
                </div>

                <!-- 导入数据 -->
                <div class="tab-content active" id="importTab">
                    <div class="form-group">
                        <label class="form-label">选择导入方式</label>
                        <select class="form-select" id="importType">
                            <option value="file">从文件导入</option>
                            <option value="git">从Git仓库导入</option>
                            <option value="text">粘贴文本</option>
                            <option value="files">选择多个文件导入</option>
                            <option value="folder">从文件夹导入</option>
                            <option value="zip">从ZIP文件导入</option>
                            <option value="json">从JSON文件导入</option>
                        </select>
                    </div>

                    <div class="form-group" id="fileImportSection">
                        <label class="form-label">选择Markdown文件</label>
                        <input type="file" id="fileInput" accept=".md,.markdown,.txt" class="form-input">
                    </div>

                    <div class="form-group" id="gitImportSection" style="display: none;">
                        <label class="form-label">Git仓库URL</label>
                        <input type="text" class="form-input" id="gitImportUrl"
                            placeholder="https://github.com/user/repo.git">

                        <label class="form-label">分支</label>
                        <input type="text" class="form-input" id="gitImportBranch" placeholder="master">

                        <label class="form-label">文件路径</label>
                        <input type="text" class="form-input" id="gitImportPath" placeholder="path/to/file.md">
                    </div>

                    <div class="form-group" id="textImportSection" style="display: none;">
                        <label class="form-label">粘贴Markdown内容</label>
                        <textarea class="form-textarea" id="textImportContent" placeholder="粘贴Markdown内容..."></textarea>
                    </div>
                    <!-- 多文件导入 -->
                    <div class="form-group" id="filesImportSection" style="display: none;">
                        <label class="form-label">选择Markdown文件</label>
                        <input type="file" id="fileInput" accept=".md,.markdown,.txt" class="form-input">
                    </div>

                    <!-- 文件夹导入 -->
                    <div class="form-group" id="folderImportSection" style="display: none;">
                        <label class="form-label">选择文件夹</label>
                        <input type="file" id="folderInput" webkitdirectory directory multiple class="form-input">
                    </div>

                    <!-- ZIP导入 -->
                    <div class="form-group" id="zipImportSection" style="display: none;">
                        <label class="form-label">选择ZIP文件</label>
                        <input type="file" id="zipInput" accept=".zip" class="form-input">
                    </div>

                    <!-- JSON导入 -->
                    <div class="form-group" id="jsonImportSection" style="display: none;">
                        <label class="form-label">选择JSON文件</label>
                        <input type="file" id="jsonInput" accept=".json" class="form-input">
                    </div>
                    <div id="importPreview"
                        style="display: none; max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                        <h4>导入预览</h4>
                        <div id="previewContent"></div>
                    </div>
                </div>
                <!-- 导出数据 -->
                <div class="tab-content" id="exportTab">
                    <div class="form-group">
                        <label class="form-label">选择导出方式</label>
                        <select class="form-select" id="exportType">
                            <option value="single">导出当前文件</option>
                            <option value="batch">批量导出所有文件</option>
                            <option value="git">导出到Git仓库</option>
                        </select>
                    </div>

                    <div class="form-group" id="singleExportSection">
                        <label class="form-label">文件名</label>
                        <input type="text" class="form-input" id="exportFileName" value="document.md">

                        <label class="form-label">格式</label>
                        <select class="form-select" id="exportFormat">
                            <option value="md">Markdown (.md)</option>
                            <option value="html">HTML (.html)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>

                    <div class="form-group" id="batchExportSection" style="display: none;">
                        <label class="form-label">导出格式</label>
                        <select class="form-select" id="batchExportFormat">
                            <option value="zip">ZIP压缩包</option>
                            <option value="json">JSON格式</option>
                        </select>
                    </div>

                    <div class="form-group" id="gitExportSection" style="display: none;">
                        <label class="form-label">目标仓库</label>
                        <select class="form-select" id="gitExportRepo">
                            <option value="primary">主仓库</option>
                            <option value="backup1">备份仓库 1</option>
                            <option value="backup2">备份仓库 2</option>
                        </select>

                        <label class="form-label">分支</label>
                        <input type="text" class="form-input" id="gitExportBranch" placeholder="master">

                        <label class="form-label">文件路径</label>
                        <input type="text" class="form-input" id="gitExportPath" placeholder="path/to/file.md">

                        <label class="form-label">提交信息</label>
                        <input type="text" class="form-input" id="gitExportMessage" placeholder="更新文档">
                    </div>
                </div>


                <div class="modal-footer">
                    <button class="editor-btn secondary" id="cancelData">取消</button>
                    <button class="editor-btn" id="confirmData">确认</button>
                </div>
            </div>
        </div>
        <script>
            class MarkdownManager {
                constructor() {
                    this.init()

                }
                init() {

                }
            }
            // 初始化编辑器
            document.addEventListener('DOMContentLoaded', function () {
                // DOM元素
                const editor = document.getElementById('editor');
                const preview = document.getElementById('preview');
                const sidebar = document.querySelector('.sidebar');
                const sidebarToggle = document.getElementById('sidebarToggle');
                const logo = document.getElementById('logo');
                const syncBtn = document.getElementById('syncBtn');
                const fileList = document.getElementById('fileList');
                const addFileBtn = document.getElementById('addFileBtn');
                const editorTitle = document.getElementById('editorTitle');
                const wordCount = document.getElementById('wordCount');
                const syncStatus = document.getElementById('syncStatus');
                const storageTypeEl = document.getElementById('storageType');

                // 模态框元素
                const viewModal = document.getElementById('viewModal');
                const prefModal = document.getElementById('prefModal');
                const historyModal = document.getElementById('historyModal');
                const storageModal = document.getElementById('storageModal');
                const dataModal = document.getElementById('dataModal');

                // 菜单按钮
                const viewMenu = document.getElementById('viewMenu');
                const prefMenu = document.getElementById('prefMenu');
                const historyMenu = document.getElementById('historyMenu');
                const storageMenu = document.getElementById('storageMenu');
                const dataMenu = document.getElementById('dataMenu');

                // 应用状态
                let files = [];
                let currentFileId = null;
                let appConfig = {
                    theme: 'light',
                    fontSize: 16,
                    viewMode: 'edit',
                    storage: {
                        local: {
                            autoSave: true,
                            saveInterval: 30
                        },
                        git: {
                            repoUrl: '',
                            branch: 'master',
                            token: '',
                            autoSync: true
                        },
                        webdav: {
                            url: '',
                            user: '',
                            pass: '',
                            path: '/markdown'
                        }
                    }
                };
                // 图床配置数据结构
                const imageHostConfig = {
                    defaultService: 'github',
                    services: {
                        github: {
                            username: '',
                            repo: '',
                            branch: 'master',
                            path: '',
                            token: '',
                            customDomain: '',
                            enabled: true
                        },
                        gitee: {
                            username: '',
                            repo: '',
                            branch: 'master',
                            path: '',
                            token: '',
                            customDomain: '',
                            enabled: true
                        },
                        custom: {
                            apiUrl: '',
                            uploadPath: '',
                            apiKey: '',
                            customDomain: '',
                            enabled: false
                        }
                    }
                };


                addImageContextMenu();
                initImageHostConfig();



                // 初始化多点Git存储配置
                initMultiGitConfig();

                initStorageTabs();
                let userPassword = "123"
                let commitMessage = `更新文档-${new Date().toISOString()}`
                // 保存存储设置时记住当前tab
                function saveStorageSettings() {
                    const activeTab = document.querySelector('.tab.active').dataset.tab;
                    localStorage.setItem('lastActiveStorageTab', activeTab);

                    // 更新状态栏显示存储方式
                    updateStorageStatus();
                }

                // 更新状态栏显示存储方式
                function updateStorageStatus() {
                    const storageStatus = document.getElementById('storageStatus');
                    const activeTab = localStorage.getItem('lastActiveStorageTab') || 'local';

                    let storageType = '本地存储';
                    if (activeTab === 'git') storageType = 'Git存储';
                    else if (activeTab === 'multigit') storageType = '多点Git存储';
                    else if (activeTab === 'webdav') storageType = 'WebDAV存储';

                    storageStatus.textContent = `存储方式: ${storageType}`;
                }

                // 初始化时恢复上次选择的tab
                function initStorageTabs() {
                    const lastActiveTab = localStorage.getItem('lastActiveStorageTab') || 'local';
                    const tabToActivate = document.querySelector(`.tab[data-tab="${lastActiveTab}"]`);

                    if (tabToActivate) {
                        // 移除所有活动状态
                        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                        // 激活选中的tab
                        tabToActivate.classList.add('active');
                        document.getElementById(`${lastActiveTab}Tab`).classList.add('active');
                    }

                    // 更新状态栏
                    updateStorageStatus();
                }
                // 保存配置时处理多点Git存储
                document.getElementById('saveStorage').addEventListener('click', function () {
                    saveMultiGitConfig();
                    saveStorageSettings();
                });
                function initMultiGitConfig() {
                    const repoList = document.getElementById('repoList');
                    repoList.innerHTML = '';

                    // 从localStorage加载配置
                    const savedConfig = JSON.parse(localStorage.getItem('multiGitConfig') || '{"repositories": []}');

                    // 添加仓库配置项
                    savedConfig.repositories.forEach(repo => {
                        addRepoItem(repo);
                    });

                    // 设置主仓库
                    if (savedConfig.primaryRepoIndex !== undefined) {
                        const primaryRadios = document.querySelectorAll('.primary-repo-radio');
                        if (primaryRadios.length > savedConfig.primaryRepoIndex) {
                            primaryRadios[savedConfig.primaryRepoIndex].checked = true;
                        }
                    }


                    // 设置自动同步
                    document.getElementById('multiAutoSync').checked = savedConfig.autoSync !== false;
                }

                // 添加仓库配置项
                function addRepoItem(config = {}) {
                    const template = document.getElementById('gitRepoItemTemplate');
                    const clone = template.content.cloneNode(true);
                    const repoItem = clone.querySelector('.git-repo-item');

                    // 填充数据
                    if (config.name) {
                        repoItem.querySelector('.repo-name').value = config.name;
                    }

                    if (config.type) {
                        repoItem.querySelector('.repo-type').value = config.type;
                        // 显示/隐藏Gitea服务器字段
                        toggleGiteaServer(repoItem, config.type);
                    }

                    if (config.token) {
                        repoItem.querySelector('.repo-token').value = config.token;
                    }

                    if (config.path) {
                        repoItem.querySelector('.repo-path').value = config.path;
                    }

                    if (config.url) {
                        repoItem.querySelector('.gitea-url').value = config.url;
                    }

                    if (config.encrypt !== undefined) {
                        const encryptSelect = repoItem.querySelector('.encrypt-option');
                        encryptSelect.value = config.encrypt ? 'yes' : 'no';
                    }
                    // 添加移除按钮事件
                    repoItem.querySelectorAll('.remove-repo-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            repoItem.remove();
                            saveMultiGitConfig();
                        });
                    });

                    // 添加仓库类型变更事件
                    repoItem.querySelector('.repo-type').addEventListener('change', function () {
                        toggleGiteaServer(repoItem, this.value);
                    });

                    // 添加主仓库选择事件
                    repoItem.querySelector('.primary-repo-radio').addEventListener('change', function () {
                        if (this.checked) {
                            saveMultiGitConfig();
                        }
                    });

                    document.getElementById('repoList').appendChild(repoItem);
                }

                // 显示/隐藏Gitea服务器字段
                function toggleGiteaServer(repoItem, type) {
                    const giteaServer = repoItem.querySelector('.gitea-server');
                    if (type === 'gitea') {
                        giteaServer.style.display = 'block';
                    } else {
                        giteaServer.style.display = 'none';
                    }
                }

                // 保存多点Git配置
                function saveMultiGitConfig() {
                    const config = {
                        repositories: [],
                        autoSync: document.getElementById('multiAutoSync').checked
                    };

                    // 收集仓库配置
                    document.querySelectorAll('.git-repo-item').forEach((item, index) => {
                        const repoConfig = {
                            name: item.querySelector('.repo-name').value,
                            type: item.querySelector('.repo-type').value,
                            token: item.querySelector('.repo-token').value,
                            path: item.querySelector('.repo-path').value,
                            encrypt: item.querySelector('.encrypt-option').value === 'yes' // 保存加密选项
                        };

                        // 如果是Gitea仓库，添加服务器地址
                        if (repoConfig.type === 'gitea') {
                            repoConfig.url = item.querySelector('.gitea-url').value;
                        }

                        // 检查是否为主仓库
                        if (item.querySelector('.primary-repo-radio').checked) {
                            config.primaryRepoIndex = index;
                        }

                        config.repositories.push(repoConfig);
                    });

                    localStorage.setItem('multiGitConfig', JSON.stringify(config));
                    return config;
                }
                // 添加仓库按钮事件
                document.getElementById('addRepoBtn').addEventListener('click', function () {
                    addRepoItem();
                    saveMultiGitConfig();
                });
                // 显示插入模态框
                document.getElementById('insertBtn').addEventListener('click', function () {
                    document.getElementById('insertModal').style.display = 'flex';

                    // 清空图片相关输入
                    document.getElementById('imageUpload').value = '';
                    document.getElementById('imageUrl').value = '';
                    document.getElementById('imageAlt').value = '';

                    // 移除预览图片
                    const preview = document.querySelector('#imageTab img');
                    if (preview) preview.remove();
                });
                // 处理本地图片上传
                document.getElementById('imageUpload').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 创建预览
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const preview = document.createElement('img');
                        preview.src = event.target.result;
                        preview.style.maxWidth = '100%';
                        preview.style.maxHeight = '200px';
                        preview.style.marginTop = '10px';

                        // 替换之前的预览
                        const existingPreview = document.querySelector('#imageTab img');
                        if (existingPreview) existingPreview.remove();

                        this.parentNode.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                });

                // 为预览图片添加右键菜单功能
                function addImageContextMenu() {
                    const preview = document.getElementById('preview');

                    // 创建自定义右键菜单
                    const contextMenu = document.createElement('div');
                    contextMenu.id = 'imageContextMenu';
                    contextMenu.style.display = 'none';
                    contextMenu.style.position = 'absolute';
                    contextMenu.style.backgroundColor = 'white';
                    contextMenu.style.border = '1px solid #ccc';
                    contextMenu.style.borderRadius = '4px';
                    contextMenu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                    contextMenu.style.zIndex = '1000';

                    const uploadOption = document.createElement('div');
                    uploadOption.textContent = '上传到图床';
                    uploadOption.style.padding = '8px 12px';
                    uploadOption.style.cursor = 'pointer';
                    uploadOption.addEventListener('click', handleImageUploadToHost);

                    contextMenu.appendChild(uploadOption);
                    document.body.appendChild(contextMenu);

                    // 监听预览区域的右键点击事件
                    preview.addEventListener('contextmenu', function (e) {
                        if (e.target.tagName === 'IMG') {
                            e.preventDefault();

                            // 保存当前点击的图片
                            window.currentContextImage = e.target;

                            // 显示菜单
                            contextMenu.style.display = 'block';
                            contextMenu.style.left = `${e.pageX}px`;
                            contextMenu.style.top = `${e.pageY}px`;
                        }
                    });

                    // 点击其他地方隐藏菜单
                    document.addEventListener('click', function () {
                        contextMenu.style.display = 'none';
                    });
                }

                // 处理图片上传到图床
                function handleImageUploadToHost() {
                    const image = window.currentContextImage;
                    if (!image) return;

                    const status = document.createElement('div');
                    status.textContent = '上传中...';
                    status.style.position = 'fixed';
                    status.style.top = '10px';
                    status.style.right = '10px';
                    status.style.padding = '8px 12px';
                    status.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    status.style.color = 'white';
                    status.style.borderRadius = '4px';
                    status.style.zIndex = '1000';
                    document.body.appendChild(status);

                    // 获取图片URL
                    const imageUrl = image.src;

                    // 如果是base64图片，需要转换为文件
                    if (imageUrl.startsWith('data:')) {
                        // 转换base64为文件
                        const blob = dataURLtoBlob(imageUrl);
                        const file = new File([blob], 'uploaded_image.png', { type: 'image/png' });

                        // 上传文件
                        uploadImageToImageHost(file, '上传的图片')
                            .then(() => {
                                status.textContent = '上传成功!';
                                setTimeout(() => status.remove(), 2000);
                            })
                            .catch(error => {
                                status.textContent = `上传失败: ${error.message}`;
                                status.style.backgroundColor = '#e74c3c';
                                setTimeout(() => status.remove(), 3000);
                            });
                    } else {
                        // 如果是外部URL，下载图片再上传
                        fetch(imageUrl)
                            .then(response => response.blob())
                            .then(blob => {
                                const file = new File([blob], 'downloaded_image.png', { type: blob.type });
                                return uploadImageToImageHost(file, '上传的图片');
                            })
                            .then(() => {
                                status.textContent = '上传成功!';
                                setTimeout(() => status.remove(), 2000);
                            })
                            .catch(error => {
                                status.textContent = `上传失败: ${error.message}`;
                                status.style.backgroundColor = '#e74c3c';
                                setTimeout(() => status.remove(), 3000);
                            });
                    }
                }

                // 将base64转换为Blob
                function dataURLtoBlob(dataurl) {
                    const arr = dataurl.split(',');
                    const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);

                    while (n--) {
                        u8arr[n] = bstr.charCodeAt(n);
                    }

                    return new Blob([u8arr], { type: mime });
                }

                // 修改上传函数返回Promise
                function uploadImageToImageHost(file, alt) {
                    return new Promise((resolve, reject) => {
                        // 获取图床配置
                        const imageHostConfig = JSON.parse(localStorage.getItem('imageHostConfig') || '{}');

                        // 生成图片URL
                        const timestamp = new Date().getTime();
                        const fileName = file.name.replace(/\.[^/.]+$/, "");
                        const fileExtension = file.name.split('.').pop();

                        // 使用自定义域名或默认URL
                        const baseUrl = imageHostConfig.customDomain || getDefaultBaseUrl(imageHostConfig.service);

                        // 构建完整URL
                        let imageUrl = `${baseUrl}/${imageHostConfig.username}/${imageHostConfig.repo}`;

                        if (imageHostConfig.path) {
                            imageUrl += `/${imageHostConfig.path}`;
                        }

                        imageUrl += `/${fileName}_${timestamp}.${fileExtension}`;

                        // 模拟上传过程
                        setTimeout(() => {
                            // 插入Markdown
                            const markdown = `![${alt}](${imageUrl})`;
                            insertAtCursor(markdown);

                            resolve(imageUrl);
                        }, 1000);
                    });
                }


                // 修改插入图片功能
                document.getElementById('insertImageBtn').addEventListener('click', function () {
                    const fileInput = document.getElementById('imageUpload');
                    const urlInput = document.getElementById('imageUrl');
                    const alt = document.getElementById('imageAlt').value || '图片';

                    if (fileInput.files.length > 0) {
                        // 处理本地图片上传
                        const file = fileInput.files[0];
                        uploadImageToImageHost(file, alt);
                    } else if (urlInput.value) {
                        // 处理URL图片
                        const markdown = `![${alt}](${urlInput.value})`;
                        insertAtCursor(markdown);
                        document.getElementById('insertModal').style.display = 'none';

                    } else {
                        alert('请选择图片或输入图片URL');
                    }


                });



                // 插入视频功能
                document.getElementById('insertVideoBtn').addEventListener('click', function () {
                    const url = document.getElementById('videoUrl').value;
                    const platform = document.getElementById('videoPlatform').value;

                    if (url) {
                        let markdown = '';
                        if (platform === 'youtube') {
                            // 提取YouTube视频ID
                            const videoId = url.match(/[?&]v=([^&]+)/)?.[1] || url.split('/').pop();
                            markdown = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                        } else if (platform === 'vimeo') {
                            const videoId = url.split('/').pop();
                            markdown = `<iframe src="https://player.vimeo.com/video/${videoId}" width="640" height="360" frameborder="0" allowfullscreen></iframe>`;
                        } else {
                            markdown = `<video src="${url}" controls></video>`;
                        }

                        insertAtCursor(markdown);
                        document.getElementById('insertModal').style.display = 'none';
                    } else {
                        alert('请输入视频URL');
                    }
                });

                // 插入文件功能
                document.getElementById('insertFileBtn').addEventListener('click', function () {
                    const url = document.getElementById('fileUrl').value;
                    const text = document.getElementById('fileText').value || '下载文件';

                    if (url) {
                        const markdown = `[${text}](${url})`;
                        insertAtCursor(markdown);
                        document.getElementById('insertModal').style.display = 'none';
                    } else {
                        alert('请输入文件URL');
                    }
                });

                <!-- 插入其他内容 -->
                document.getElementById('insertOtherBtn').addEventListener('click', function () {
                    const type = document.getElementById('otherType').value;
                    let content = '';

                    switch (type) {
                        case 'table':
                            content = `| 标题1 | 标题2 | 标题3 |
|------|------|------|
| 内容1 | 内容2 | 内容3 |
| 内容4 | 内容5 | 内容6 |`;
                            break;
                        case 'code':
                            content = "```语言\n// 在这里输入代码\n```";
                            break;
                        case 'quote':
                            content = "> 引用内容";
                            break;
                        case 'divider':
                            content = "---";
                            break;
                    }

                    if (content) {
                        insertAtCursor(content);
                        document.getElementById('insertModal').style.display = 'none';
                    }
                });

                // 在光标位置插入内容
                function insertAtCursor(text) {
                    const editor = document.getElementById('editor');
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    const before = editor.value.substring(0, start);
                    const after = editor.value.substring(end);

                    editor.value = before + text + after;
                    editor.selectionStart = start + text.length;
                    editor.selectionEnd = start + text.length;
                    editor.focus();

                    // 触发输入事件以更新预览
                    const event = new Event('input', { bubbles: true });
                    editor.dispatchEvent(event);
                }



                // 图床服务切换
                document.getElementById('imageHostService').addEventListener('change', function () {
                    document.getElementById('githubConfig').style.display = 'none';
                    document.getElementById('giteeConfig').style.display = 'none';
                    document.getElementById('customConfig').style.display = 'none';

                    if (this.value === 'github') {
                        document.getElementById('githubConfig').style.display = 'block';
                    } else if (this.value === 'gitee') {
                        document.getElementById('giteeConfig').style.display = 'block';
                    } else if (this.value === 'custom') {
                        document.getElementById('customConfig').style.display = 'block';
                    }
                });

                // 测试图床连接
                document.getElementById('testImageHostBtn').addEventListener('click', function () {
                    const service = document.getElementById('imageHostService').value;
                    let config = {};

                    if (service === 'github') {
                        config = {
                            username: document.getElementById('githubUsername').value,
                            repo: document.getElementById('githubRepo').value,
                            branch: document.getElementById('githubBranch').value,
                            path: document.getElementById('githubPath').value,
                            token: document.getElementById('githubToken').value
                        };
                    } else if (service === 'gitee') {
                        config = {
                            username: document.getElementById('giteeUsername').value,
                            repo: document.getElementById('giteeRepo').value,
                            branch: document.getElementById('giteeBranch').value,
                            path: document.getElementById('giteePath').value,
                            token: document.getElementById('giteeToken').value
                        };
                    } else if (service === 'custom') {
                        config = {
                            apiUrl: document.getElementById('customApiUrl').value,
                            uploadPath: document.getElementById('customUploadPath').value,
                            apiKey: document.getElementById('customApiKey').value
                        };
                    }

                    // 模拟测试连接
                    alert(`正在测试${service}图床连接...`);
                    // 实际实现中这里会有AJAX请求测试连接
                });


                // 模板管理功能
                const templates = JSON.parse(localStorage.getItem('mdEditorTemplates') || '[]');

                // 渲染模板列表
                function renderTemplateList() {
                    const templateList = document.getElementById('templateList');
                    templateList.innerHTML = '';

                    templates.forEach((template, index) => {
                        const templateItem = document.createElement('div');
                        templateItem.className = 'repo-item';
                        templateItem.innerHTML = `
            <input type="radio" name="template" id="template${index}" value="${index}">
            <label for="template${index}" class="repo-url">${template.name}</label>
            <div class="repo-actions">
                <button class="repo-action-btn edit-btn"><i class="fas fa-edit"></i></button>
                <button class="repo-action-btn delete-btn"><i class="fas fa-trash"></i></button>
            </div>
        `;
                        templateList.appendChild(templateItem);

                        // 编辑按钮
                        templateItem.querySelector('.edit-btn').addEventListener('click', function () {
                            document.getElementById('templateContent').value = template.content;
                        });

                        // 删除按钮
                        templateItem.querySelector('.delete-btn').addEventListener('click', function () {
                            if (confirm('确定要删除此模板吗？')) {
                                templates.splice(index, 1);
                                saveTemplates();
                                renderTemplateList();
                            }
                        });
                    });
                }

                // 添加模板按钮
                document.getElementById('addTemplateBtn').addEventListener('click', function () {
                    const templateName = prompt('请输入模板名称');
                    if (templateName && templateName.trim() !== '') {
                        const templateContent = document.getElementById('templateContent').value;
                        if (templateContent.trim() !== '') {
                            templates.push({
                                name: templateName.trim(),
                                content: templateContent
                            });
                            saveTemplates();
                            renderTemplateList();
                        } else {
                            alert('模板内容不能为空');
                        }
                    }
                });

                // 保存模板
                function saveTemplates() {
                    localStorage.setItem('mdEditorTemplates', JSON.stringify(templates));
                }

                // 在新建文件时应用模板
                function createNewFile(name, content = '', customVars = {}) {
                    // 替换内置变量
                    const now = new Date();
                    const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const fileNameWithoutExt = name.replace(/\.\w+$/, '');

                    // 内置变量映射
                    const builtInVars = {
                        '{{date}}': formattedDate,
                        '{{time}}': formattedTime,
                        '{{datetime}}': `${formattedDate} ${formattedTime}`,
                        '{{filename}}': fileNameWithoutExt,
                        '{{year}}': now.getFullYear().toString(),
                        '{{month}}': (now.getMonth() + 1).toString().padStart(2, '0'),
                        '{{day}}': now.getDate().toString().padStart(2, '0')
                    };

                    // 应用内置变量替换
                    let processedContent = content;
                    for (const [key, value] of Object.entries(builtInVars)) {
                        processedContent = processedContent.replace(new RegExp(key, 'g'), value);
                    }

                    // 应用自定义变量替换
                    for (const [key, value] of Object.entries(customVars)) {
                        processedContent = processedContent.replace(new RegExp(`{{${key}}}`, 'g'), value);
                    }

                    // 创建新文件
                    const newFile = {
                        id: Date.now().toString(),
                        name: name,
                        content: processedContent,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        history: []
                    };

                    files.push(newFile);
                    saveFiles();
                    renderFileList();
                    openFile(newFile.id);
                    return newFile;
                }

                // 初始化文件系统
                function initFileSystem() {
                    // 尝试从localStorage加载文件
                    const savedFiles = localStorage.getItem('mdEditorFiles');
                    if (savedFiles) {
                        try {
                            files = JSON.parse(savedFiles);
                        } catch (e) {
                            console.error('Failed to parse saved files', e);
                            files = [];
                        }
                    }

                    // 如果没有文件，创建一个默认文件
                    if (files.length === 0) {
                        createNewFile('欢迎使用.md', `# 欢迎使用Markdown编辑器

这是一个所见即所得的Markdown编辑器，灵感来源于Typora。

## 主要功能

- **实时渲染**：输入Markdown标签后回车即可看到渲染效果
- **文件管理**：左侧文件列表可管理多个文档
- **Git同步**：支持加密同步到多个Git仓库
- **导入导出**：支持导入和导出文档及配置

### 使用示例

\`\`\`javascript
function helloWorld() {
    console.log('Hello, Markdown Editor!');
}
\`\`\`

> 提示：尝试输入Markdown语法查看实时渲染效果

**加粗文本** 和 *斜体文本*

[这是一个链接](https://example.com)

| 功能         | 状态     |
|--------------|----------|
| 实时渲染     | 已启用   |
| Git同步      | 已配置   |
| 导入/导出    | 可用     |
`);
                    }

                    // 尝试从localStorage加载配置
                    const savedConfig = localStorage.getItem('mdEditorConfig');
                    if (savedConfig) {
                        try {
                            appConfig = JSON.parse(savedConfig);
                            applyConfig();
                        } catch (e) {
                            console.error('Failed to parse config', e);
                        }
                    }

                    // 渲染文件列表
                    renderFileList();

                    // 打开第一个文件
                    if (files.length > 0) {
                        openFile(files[0].id);
                    }
                }

                // 应用配置
                function applyConfig() {
                    // 应用主题
                    if (appConfig.theme === 'dark') {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }

                    // 应用字体大小
                    editor.style.fontSize = appConfig.fontSize + 'px';
                    document.getElementById('fontSizeValue').textContent = appConfig.fontSize + 'px';

                    // 应用视图模式
                    updateViewMode();

                    // 更新单选按钮状态
                    document.querySelectorAll('input[name="theme"]').forEach(radio => {
                        if (radio.value === appConfig.theme) {
                            radio.checked = true;
                        }
                    });

                    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                        if (radio.value === appConfig.viewMode) {
                            radio.checked = true;
                        }
                    });
                }


                // 保存文件
                function saveFile(fileId, content) {
                    const file = files.find(f => f.id === fileId);
                    if (file) {
                        // 添加到历史记录
                        if (file.content !== content) {
                            file.history.push({
                                content: file.content,
                                savedAt: new Date()
                            });

                            // 保留最多10个历史版本
                            if (file.history.length > 10) {
                                file.history.shift();
                            }
                        }

                        file.content = content;
                        file.updatedAt = new Date();
                        saveFiles();

                        // 更新文件列表中的更新时间
                        const fileElement = document.querySelector(`.file-item[data-id="${fileId}"]`);
                        if (fileElement) {
                            const timeElement = fileElement.querySelector('.file-time');
                            if (timeElement) {
                                timeElement.textContent = formatDate(file.updatedAt);
                            }
                        }

                        // 自动同步
                        if (appConfig.storage.git.autoSync && appConfig.storage.git.repoUrl) {
                            syncToGit();
                        }
                    }
                }
                let masterKey = deriveKey(userPassword);
                // 派生密钥
                function deriveKey(password) {
                    // 在实际应用中应使用更安全的密钥派生算法如PBKDF2
                    // 这里简化处理，实际应用中应使用CryptoJS.PBKDF2
                    return CryptoJS.SHA256(password).toString();
                }

                // 加密数据
                function encryptData(data) {
                    return CryptoJS.AES.encrypt(data, masterKey).toString();
                }

                // 解密数据
                function decryptData(ciphertext) {
                    const bytes = CryptoJS.AES.decrypt(ciphertext, masterKey);
                    return bytes.toString(CryptoJS.enc.Utf8);
                }
                // 保存所有文件到localStorage
                function saveFiles() {
                    const files = JSON.parse(localStorage.getItem('mdEditorFiles') || '[]');
                    const passwordHash = localStorage.getItem('passwordHash');

                    if (passwordHash) {
                        // 用户设置了密码，加密存储数据
                        const encryptionKey = deriveKeyFromPassword(userPassword);
                        const jsonData = JSON.stringify(files);

                        try {
                            localStorage.setItem('encryptedFiles', encryptData(jsonData));
                            // 清除未加密的数据
                            localStorage.removeItem('mdEditorFiles');

                        } catch {
                            console.error('加密失败:', error);
                            // 加密失败时使用未加密存储
                            localStorage.setItem('mdEditorFiles', JSON.stringify(files));
                        }
                    } else {
                        // 没有设置密码，正常存储
                        localStorage.setItem('mdEditorFiles', JSON.stringify(files));
                    }
                }

                // 修改加载文件函数
                function loadFiles(password) {
                    const encryptedData = localStorage.getItem('encryptedFiles');

                    if (encryptedData && password) {
                        // 尝试解密数据
                        return decryptData(encryptedData)
                    }

                    // 没有加密数据或没有密码，加载未加密数据
                    const savedFiles = localStorage.getItem('mdEditorFiles');
                    return savedFiles ? JSON.parse(savedFiles) : [];
                }


                // 保存配置
                function saveConfig() {
                    localStorage.setItem('mdEditorConfig', JSON.stringify(appConfig));
                }

                // 打开文件
                function openFile(fileId) {
                    const file = files.find(f => f.id === fileId);
                    if (file) {
                        currentFileId = file.id;
                        editor.value = file.content;
                        editorTitle.textContent = file.name;

                        // 更新预览
                        updatePreview();

                        // 更新文件列表中的活动状态
                        document.querySelectorAll('.file-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        const activeItem = document.querySelector(`.file-item[data-id="${fileId}"]`);
                        if (activeItem) {
                            activeItem.classList.add('active');
                        }

                        // 更新字数统计
                        updateWordCount();
                    }
                }

                // 删除文件
                function deleteFile(fileId) {
                    if (files.length <= 1) {
                        alert('不能删除最后一个文件');
                        return;
                    }

                    if (confirm('确定要删除此文件吗？')) {
                        const index = files.findIndex(f => f.id === fileId);
                        if (index !== -1) {
                            files.splice(index, 1);
                            saveFiles();
                            renderFileList();

                            // 如果删除的是当前打开的文件，打开第一个文件
                            if (fileId === currentFileId) {
                                openFile(files[0].id);
                            }
                        }
                    }
                }

                // 重命名文件
                function renameFile(fileId, newName) {
                    if (!newName.endsWith('.md')) {
                        newName += '.md';
                    }

                    const file = files.find(f => f.id === fileId);
                    if (file) {
                        file.name = newName;
                        saveFiles();
                        renderFileList();

                        // 如果重命名的是当前打开的文件，更新标题
                        if (fileId === currentFileId) {
                            editorTitle.textContent = newName;
                        }
                    }
                }
                // 导出文件
                function exportFile() {
                    if (!currentFileId) return;

                    const file = files.find(f => f.id === currentFileId);
                    if (!file) return;

                    const blob = new Blob([file.content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();

                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
                // 导入文件
                function importFile(file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result;
                        const name = file.name.endsWith('.md') ? file.name : file.name + '.md';
                        createNewFile(name, content);
                    };
                    reader.readAsText(file);
                }


                // 动态加载JSZip库
                function loadJSZip() {
                    return new Promise((resolve, reject) => {
                        if (typeof JSZip !== 'undefined') {
                            resolve();
                            return;
                        }

                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

                // 实现saveAs函数
                function saveAs(blob, filename) {
                    if (typeof navigator.msSaveBlob !== 'undefined') {
                        // IE支持
                        navigator.msSaveBlob(blob, filename);
                    } else {
                        // 其他浏览器
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);

                        link.href = url;
                        link.download = filename;
                        link.style.display = 'none';

                        document.body.appendChild(link);
                        link.click();

                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 100);
                    }
                }

                // 修改批量导出为ZIP函数
                async function exportAllFilesAsZip() {
                    try {
                        // 确保JSZip已加载
                        await loadJSZip();

                        const zip = new JSZip();

                        // 添加文件
                        files.forEach(file => {
                            zip.file(file.name, file.content);
                        });

                        // 生成ZIP文件
                        const content = await zip.generateAsync({ type: "blob" });
                        saveAs(content, "markdown_files.zip");
                        showStatusMessage('ZIP文件已生成');
                    } catch (error) {
                        showStatusMessage(`导出失败: ${error.message}`, 'error');
                    }
                }

                // 修改批量导出为JSON函数
                function exportAllFilesAsJson() {
                    try {
                        const exportData = {
                            exportedAt: new Date().toISOString(),
                            files: files.map(file => ({
                                id: file.id,
                                name: file.name,
                                content: file.content,
                                createdAt: file.createdAt,
                                updatedAt: file.updatedAt
                            }))
                        };

                        const jsonStr = JSON.stringify(exportData, null, 2);
                        const blob = new Blob([jsonStr], { type: "application/json" });
                        saveAs(blob, "markdown_files.json");
                        showStatusMessage('JSON文件已生成');
                    } catch (error) {
                        showStatusMessage(`导出失败: ${error.message}`, 'error');
                    }
                }
                // 渲染文件列表
                function renderFileList() {
                    fileList.innerHTML = '';

                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        if (file.id === currentFileId) {
                            fileItem.classList.add('active');
                        }
                        fileItem.dataset.id = file.id;

                        fileItem.innerHTML = `
                        <i class="far fa-file-alt"></i>
                        <div class="file-name">${file.name}</div>
                        <div class="file-time">${formatDate(file.updatedAt)}</div>
                        <div class="file-actions">
                            <button class="file-action-btn rename-btn"><i class="fas fa-pencil-alt"></i></button>
                            <button class="file-action-btn delete-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;

                        fileList.appendChild(fileItem);

                        // 添加事件监听
                        fileItem.addEventListener('click', function (e) {
                            if (!e.target.closest('.file-action-btn')) {
                                openFile(file.id);
                            }
                        });

                        // 重命名按钮
                        const renameBtn = fileItem.querySelector('.rename-btn');
                        renameBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const newName = prompt('请输入新文件名', file.name);
                            if (newName && newName.trim() !== '') {
                                renameFile(file.id, newName.trim());
                            }
                        });

                        // 删除按钮
                        const deleteBtn = fileItem.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            deleteFile(file.id);
                        });
                    });
                }

                // 格式化日期
                function formatDate(date) {
                    const d = new Date(date);
                    return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                }

                // 更新预览
                function updatePreview() {
                    preview.innerHTML = marked.parse(editor.value);

                    // 高亮代码块 - 修复highlight.js问题
                    document.querySelectorAll('pre code').forEach((block) => {
                        // hljs.highlightElement(block);
                    });
                }

                // 更新视图模式
                function updateViewMode() {
                    // 隐藏所有编辑器模式
                    document.querySelectorAll('.editor-mode').forEach(mode => {
                        mode.classList.remove('active');
                    });

                    // 移除分屏视图类
                    document.querySelector('.editor-content').classList.remove('split-view');

                    switch (appConfig.viewMode) {
                        case 'edit':
                            document.getElementById('editMode').classList.add('active');
                            break;
                        case 'preview':
                            document.getElementById('previewMode').classList.add('active');
                            updatePreview();
                            // 切换到预览视图时自动保存
                            if (currentFileId) {
                                saveFile(currentFileId, editor.value);
                                showStatusMessage('文档已自动保存');
                            }
                            break;
                        case 'split':
                            document.querySelector('.editor-content').classList.add('split-view');
                            document.getElementById('editMode').classList.add('active');
                            document.getElementById('previewMode').classList.add('active');
                            updatePreview();
                            break;
                    }
                }
                // 显示状态消息
                function showStatusMessage(message) {
                    const statusBar = document.querySelector('.status-bar');
                    const messageElement = document.createElement('div');
                    messageElement.textContent = message;
                    messageElement.style.color = 'var(--success-color)';
                    messageElement.style.marginLeft = '15px';
                    messageElement.style.animation = 'fadeOut 3s forwards';

                    // 添加淡出动画
                    const style = document.createElement('style');
                    style.textContent = `
    @keyframes fadeOut {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }
  `;
                    document.head.appendChild(style);

                    // 移除旧的消息
                    const oldMessage = statusBar.querySelector('.status-message');
                    if (oldMessage) oldMessage.remove();

                    messageElement.classList.add('status-message');
                    statusBar.appendChild(messageElement);

                    // 3秒后移除消息
                    setTimeout(() => {
                        messageElement.remove();
                    }, 3000);
                }

                // 更新字数统计
                function updateWordCount() {
                    const text = editor.value;
                    const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
                    wordCount.textContent = words;
                }

                // 同步到Git
                function syncToGit() {
                    if (!currentFileId) return;

                    const file = files.find(f => f.id === currentFileId);
                    if (!file) return;

                    // 更新同步状态
                    syncStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>同步中...</span>';
                    syncStatus.classList.remove('synced', 'error');

                    // 模拟同步过程
                    setTimeout(() => {
                        // 随机决定成功或失败
                        const success = Math.random() > 0.2;

                        if (success) {
                            syncStatus.innerHTML = '<i class="fas fa-check-circle"></i> <span>同步成功</span>';
                            syncStatus.classList.add('synced');
                        } else {
                            syncStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>同步失败</span>';
                            syncStatus.classList.add('error');
                        }
                    }, 2000);
                }

                // 配置Markdown渲染
                marked.setOptions({
                    gfm: true,
                    breaks: true,
                    highlight: function (code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(lang, code).value;
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });

                // 初始渲染
                initFileSystem();

                // 事件监听
                editor.addEventListener('input', function () {
                    if (currentFileId) {
                        saveFile(currentFileId, editor.value);
                    }
                    updatePreview();
                    updateWordCount();
                });

                // 切换侧边栏
                sidebarToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                    const icon = sidebarToggle.querySelector('i');
                    if (sidebar.classList.contains('collapsed')) {
                        icon.className = 'fas fa-chevron-right';
                    } else {
                        icon.className = 'fas fa-chevron-left';
                    }
                });

                // 切换侧边栏
                logo.addEventListener('click', function () {
                    sidebar.classList.toggle('open');
                });

                // 新建文件
                // addFileBtn.addEventListener('click', function () {
                //     const fileName = prompt('请输入新文件名（以.md结尾）', '新文档.md');
                //     if (fileName && fileName.trim() !== '') {
                //         createNewFile(fileName.trim());
                //     }
                // });

                // 新建文件
                addFileBtn.addEventListener('click', function () {
                    // 显示模板选择对话框
                    const templateDialog = document.createElement('div');
                    templateDialog.style.position = 'fixed';
                    templateDialog.style.top = '0';
                    templateDialog.style.left = '0';
                    templateDialog.style.width = '100%';
                    templateDialog.style.height = '100%';
                    templateDialog.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    templateDialog.style.zIndex = '1000';
                    templateDialog.style.display = 'flex';
                    templateDialog.style.justifyContent = 'center';
                    templateDialog.style.alignItems = 'center';

                    templateDialog.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px;">
            <h3>选择模板</h3>
            <div id="templateSelection" style="margin: 15px 0;">
                <div>
                    <input type="radio" name="template" id="noTemplate" value="none" checked>
                    <label for="noTemplate">无模板</label>
                </div>
                <!-- 模板选项将通过JS动态生成 -->
            </div>
            <div id="customVarsSection" style="display: none; margin-bottom: 15px;">
                <h4>自定义变量</h4>
                <div id="customVarsContainer"></div>
                <button id="addVarBtn" class="editor-btn secondary" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> 添加变量
                </button>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="fileNameInput">文件名：</label>
                <input type="text" id="fileNameInput" value="新文档.md" style="width: 100%; padding: 8px;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelTemplateBtn" class="editor-btn secondary">取消</button>
                <button id="confirmTemplateBtn" class="editor-btn">创建</button>
            </div>
        </div>
    `;

                    document.body.appendChild(templateDialog);

                    // 渲染模板选项
                    const templateSelection = document.getElementById('templateSelection');
                    templates.forEach((template, index) => {
                        const templateOption = document.createElement('div');
                        templateOption.innerHTML = `
            <input type="radio" name="template" id="template${index}" value="${index}">
            <label for="template${index}">${template.name}</label>
        `;
                        templateSelection.appendChild(templateOption);
                    });

                    // 监听模板选择变化
                    document.querySelectorAll('input[name="template"]').forEach(radio => {
                        radio.addEventListener('change', function () {
                            const customVarsSection = document.getElementById('customVarsSection');
                            customVarsSection.style.display = this.value === 'none' ? 'none' : 'block';
                        });
                    });

                    // 添加变量按钮
                    document.getElementById('addVarBtn').addEventListener('click', function () {
                        const varContainer = document.getElementById('customVarsContainer');
                        const varIndex = varContainer.children.length;

                        const varInput = document.createElement('div');
                        varInput.style.display = 'flex';
                        varInput.style.marginBottom = '5px';
                        varInput.innerHTML = `
            <input type="text" placeholder="变量名" style="flex: 1; margin-right: 5px; padding: 5px;">
            <input type="text" placeholder="值" style="flex: 2; padding: 5px;">
        `;
                        varContainer.appendChild(varInput);
                    });

                    // 取消按钮
                    document.getElementById('cancelTemplateBtn').addEventListener('click', function () {
                        document.body.removeChild(templateDialog);
                    });

                    // 确认按钮
                    document.getElementById('confirmTemplateBtn').addEventListener('click', function () {
                        const fileName = document.getElementById('fileNameInput').value.trim();
                        if (!fileName) {
                            alert('请输入文件名');
                            return;
                        }

                        const selectedTemplate = document.querySelector('input[name="template"]:checked');
                        let templateContent = '';
                        let customVars = {};

                        if (selectedTemplate && selectedTemplate.value !== 'none') {
                            const templateIndex = parseInt(selectedTemplate.value);
                            templateContent = templates[templateIndex].content;

                            // 收集自定义变量
                            const varInputs = document.querySelectorAll('#customVarsContainer > div');
                            varInputs.forEach(inputDiv => {
                                const keyInput = inputDiv.querySelector('input:first-child');
                                const valueInput = inputDiv.querySelector('input:last-child');
                                if (keyInput.value && valueInput.value) {
                                    customVars[keyInput.value] = valueInput.value;
                                }
                            });
                        }

                        document.body.removeChild(templateDialog);
                        createNewFile(fileName, templateContent, customVars);
                    });

                });

                // 同步按钮点击事件
                syncBtn.addEventListener('click', function () {

                    // 显示提交信息模态框
                    document.getElementById('commitModal').style.display = 'flex';

                    // 填充仓库选项 - 默认选择所有仓库
                    const repoSelect = document.getElementById('commitRepoSelect');
                    repoSelect.innerHTML = '';

                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');
                    if (config.repositories && config.repositories.length > 0) {
                        // 添加"所有仓库"选项
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = '所有仓库';
                        repoSelect.appendChild(allOption);

                        // 添加单个仓库选项
                        config.repositories.forEach((repo, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = repo.name || `仓库 ${index + 1}`;
                            repoSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.textContent = '未配置仓库';
                        repoSelect.appendChild(option);
                    }

                });


                // 修改确认提交按钮事件
                document.getElementById('confirmCommit').addEventListener('click', function () {
                    commitMessage = document.getElementById('commitMessage').value || '更新文档';
                    console.log("gdgf" + document.getElementById('commitMessage').value);

                    const repoSelection = document.getElementById('commitRepoSelect').value;

                    // 隐藏模态框
                    document.getElementById('commitModal').style.display = 'none';

                    // 执行同步
                    if (repoSelection === 'all') {
                        // 同步到所有仓库
                        syncAllFilesToRepositories();
                    } else {
                        // 同步到单个仓库
                        syncToRepository(repoSelection);
                    }
                });
                // 同步到指定仓库
                async function syncToRepository(repoIndex) {
                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');
                    if (!config.repositories || config.repositories.length <= repoIndex) {
                        showStatusMessage('仓库配置无效');
                        return;
                    }

                    const repo = config.repositories[repoIndex];
                    const fileName = 'markdown_files.json';

                    try {
                        // 获取所有文件数据
                        const allFiles = JSON.parse(localStorage.getItem('mdEditorFiles') || '[]');

                        // 创建包含所有文件的JSON对象
                        const jsonData = {
                            version: 1,
                            exportedAt: new Date().toISOString(),
                            files: allFiles
                        };

                        const jsonString = JSON.stringify(jsonData, null, 2);

                        // 更新同步状态
                        syncStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>同步中...</span>';
                        syncStatus.classList.remove('synced', 'error');

                        await syncJsonToRepository(jsonString, repo);

                        syncStatus.innerHTML = '<i class="fas fa-check-circle"></i> <span>同步成功</span>';
                        syncStatus.classList.add('synced');
                    } catch (error) {
                        syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>同步失败: ${error.message}</span>`;
                        syncStatus.classList.add('error');
                    }
                }
                // 视图菜单点击事件 - 循环切换视图模式
                viewMenu.addEventListener('click', function () {
                    const modes = ['edit', 'preview', 'split'];
                    const currentIndex = modes.indexOf(appConfig.viewMode);
                    const nextIndex = (currentIndex + 1) % modes.length;
                    appConfig.viewMode = modes[nextIndex];

                    applyConfig();
                    saveConfig();

                    // 显示当前模式提示
                    let modeName = '';
                    switch (appConfig.viewMode) {
                        case 'edit': modeName = '编辑模式'; break;
                        case 'preview': modeName = '预览模式'; break;
                        case 'split': modeName = '分屏模式'; break;
                    }

                    // 临时显示提示
                    const tempMsg = document.createElement('div');
                    tempMsg.textContent = `已切换到${modeName}`;
                    tempMsg.style.position = 'fixed';
                    tempMsg.style.top = '50%';
                    tempMsg.style.left = '50%';
                    tempMsg.style.transform = 'translate(-50%, -50%)';
                    tempMsg.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    tempMsg.style.color = 'white';
                    tempMsg.style.padding = '10px 20px';
                    tempMsg.style.borderRadius = '5px';
                    tempMsg.style.zIndex = '1000';
                    document.body.appendChild(tempMsg);

                    setTimeout(() => {
                        document.body.removeChild(tempMsg);
                    }, 1500);
                });

                // 偏好设置菜单
                prefMenu.addEventListener('click', function () {
                    prefModal.style.display = 'flex';
                });

                // 历史版本菜单
                historyMenu.addEventListener('click', function () {
                    historyModal.style.display = 'flex';
                    renderRemoteHistoryRepos();
                    renderHistoryFileSelect();
                    // 渲染仓库选择下拉菜单
                });

                // 存储设置菜单
                storageMenu.addEventListener('click', function () {
                    storageModal.style.display = 'flex';
                });

                // 数据导入导出菜单
                dataMenu.addEventListener('click', function () {
                    dataModal.style.display = 'flex';
                    updateExportRepoOptions();
                });
                // 更新数据导出模态框中的仓库选项
                function updateExportRepoOptions() {
                    const repoSelect = document.getElementById('gitExportRepo');
                    repoSelect.innerHTML = '<option value="">选择仓库</option>';

                    // 从localStorage加载配置
                    const multiGitConfig = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');

                    // 添加仓库选项
                    if (multiGitConfig.repositories && multiGitConfig.repositories.length > 0) {
                        multiGitConfig.repositories.forEach((repo, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = repo.name || `仓库 ${index + 1}`;
                            repoSelect.appendChild(option);
                        });
                    }
                }
                // 关闭模态框
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.closest('.modal').style.display = 'none';
                    });
                });

                document.getElementById('cancelView').addEventListener('click', function () {
                    viewModal.style.display = 'none';
                });

                document.getElementById('saveView').addEventListener('click', function () {
                    const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
                    appConfig.viewMode = viewMode;
                    applyConfig();
                    saveConfig();
                    viewModal.style.display = 'none';
                });

                document.getElementById('cancelPref').addEventListener('click', function () {
                    prefModal.style.display = 'none';
                });

                document.getElementById('savePref').addEventListener('click', function () {
                    const theme = document.querySelector('input[name="theme"]:checked').value;
                    const fontSize = parseInt(document.getElementById('fontSize').value);

                    appConfig.theme = theme;
                    appConfig.fontSize = fontSize;

                    applyConfig();
                    saveConfig();
                    saveImageHostConfig()
                    prefModal.style.display = 'none';
                });

                document.getElementById('closeHistory').addEventListener('click', function () {
                    historyModal.style.display = 'none';
                });

                document.getElementById('cancelStorage').addEventListener('click', function () {
                    storageModal.style.display = 'none';
                });

                document.getElementById('saveStorage').addEventListener('click', function () {
                    // 本地存储设置
                    appConfig.storage.local.autoSave = document.getElementById('autoSave').checked;
                    appConfig.storage.local.saveInterval = parseInt(document.getElementById('saveInterval').value);

                    // Git存储设置
                    appConfig.storage.git.repoUrl = document.getElementById('gitRepoUrl').value;
                    appConfig.storage.git.branch = document.getElementById('gitBranch').value;
                    appConfig.storage.git.token = document.getElementById('gitToken').value;
                    appConfig.storage.git.autoSync = document.getElementById('gitAutoSync').checked;

                    // WebDAV存储设置
                    appConfig.storage.webdav.url = document.getElementById('webdavUrl').value;
                    appConfig.storage.webdav.user = document.getElementById('webdavUser').value;
                    appConfig.storage.webdav.pass = document.getElementById('webdavPass').value;
                    appConfig.storage.webdav.path = document.getElementById('webdavPath').value;

                    saveConfig();
                    storageModal.style.display = 'none';
                    alert('存储设置已保存！');
                });

                // 标签切换
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function () {
                        const tabId = this.dataset.tab;
                        console.log("------" + tabId);

                        // 移除所有活动标签
                        document.querySelectorAll('.tab').forEach(t => {
                            t.classList.remove('active');
                        });

                        // 隐藏所有标签内容
                        document.querySelectorAll('.tab-content').forEach(c => {
                            c.classList.remove('active');
                        });

                        // 激活当前标签
                        this.classList.add('active');
                        document.getElementById(tabId + 'Tab').classList.add('active');
                    });
                });

                // 字体大小调整
                document.getElementById('fontSize').addEventListener('input', function () {
                    document.getElementById('fontSizeValue').textContent = this.value + 'px';
                });

                // 导出配置
                document.getElementById('exportConfigBtn').addEventListener('click', function () {
                    const blob = new Blob([JSON.stringify(appConfig, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'md_editor_config.json';
                    document.body.appendChild(a);
                    a.click();

                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                });

                // 导入配置
                document.getElementById('configImport').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();

                        reader.onload = function (event) {
                            try {
                                const config = JSON.parse(event.target.result);
                                appConfig = config;
                                applyConfig();
                                saveConfig();
                                alert('配置导入成功！');
                            } catch (error) {
                                alert('配置文件格式错误');
                            }
                        };

                        reader.readAsText(file);
                    }
                });

                // 渲染历史文件选择
                function renderHistoryFileSelect() {
                    const select = document.getElementById('localHistoryFileSelect');
                    select.innerHTML = '';

                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = file.name;
                        select.appendChild(option);
                    });

                    if (files.length > 0) {
                        select.value = currentFileId;
                        renderHistoryList(currentFileId);
                    }

                    select.addEventListener('change', function () {
                        console.log("改变了");

                        renderHistoryList(this.value);
                    });
                }

                // 渲染历史版本列表
                function renderHistoryList(fileId) {
                    const historyList = document.getElementById('localHistoryList');
                    historyList.innerHTML = '';

                    const file = files.find(f => f.id === fileId);
                    console.log("历史数量:" + file.history);

                    if (file && file.history.length > 0) {
                        file.history.forEach((version, index) => {
                            const versionItem = document.createElement('div');
                            versionItem.className = 'repo-item';
                            versionItem.innerHTML = `
                            <input type="radio" name="historyVersion" id="version${index}" value="${index}">
                            <label for="version${index}" class="repo-url">${formatDate(version.savedAt)}</label>
                        `;
                            historyList.appendChild(versionItem);
                        });
                    } else {
                        historyList.innerHTML = '<p>暂无历史版本</p>';
                    }
                }
                // 渲染远程仓库选择下拉菜单
                function renderRemoteHistoryRepos() {
                    const select = document.getElementById('remoteHistoryRepoSelect');
                    select.innerHTML = '';
                    // console.log("------"+发过的);

                    // 从localStorage加载配置
                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');

                    if (!config.repositories || config.repositories.length === 0) {
                        // 没有配置仓库
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '未配置仓库';
                        option.disabled = true;
                        select.appendChild(option);
                        return;
                    }

                    // 查找主仓库索引
                    let primaryIndex = 0;
                    if (config.primaryRepoIndex !== undefined) {
                        primaryIndex = config.primaryRepoIndex;
                    }

                    // 添加仓库选项
                    config.repositories.forEach((repo, index) => {
                        const option = document.createElement('option');
                        option.value = index;

                        // 构建显示文本
                        let displayText = repo.name || `仓库 ${index + 1}`;

                        // 如果是主仓库，添加标记
                        if (index === primaryIndex) {
                            displayText += ' (主仓库)';
                            option.selected = true;
                        }

                        // 添加仓库类型信息
                        if (repo.type) {
                            displayText += ` [${repo.type.toUpperCase()}]`;
                        }

                        option.textContent = displayText;
                        select.appendChild(option);
                    });

                    // 加载默认仓库的历史记录
                    loadRemoteHistoryCommits(primaryIndex);
                }

                // 仓库选择变化事件
                document.getElementById('remoteHistoryRepoSelect').addEventListener('change', function () {
                    const repoIndex = this.value;
                    if (repoIndex !== '') {
                        loadRemoteHistoryCommits(repoIndex);
                    }
                });

                // 加载远程仓库的历史提交记录
                async function loadRemoteHistoryCommits(repoIndex) {
                    const historyList = document.getElementById('remoteHistoryList');
                    historyList.innerHTML = '<div class="loading">加载中...</div>';

                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');
                    const repo = config.repositories[repoIndex];

                    if (!repo) {
                        historyList.innerHTML = '<div class="error">仓库配置无效</div>';
                        return;
                    }

                    try {
                        let commits = [];

                        // 根据仓库类型调用API
                        switch (repo.type) {
                            case 'github':
                                commits = await fetchGitHubCommits(repo);
                                break;
                            case 'gitee':
                                commits = await fetchGiteeCommits(repo);
                                break;
                            case 'gitea':
                                commits = await fetchGiteaCommits(repo);
                                break;
                            case 'gitlab':
                                commits = await fetchGitLabCommits(repo);
                                break;
                            default:
                                throw new Error(`不支持的仓库类型: ${repo.type}`);
                        }

                        // 渲染历史记录
                        renderRemoteHistoryList(commits);
                    } catch (error) {
                        historyList.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
                    }
                }
                // 修改fetchFileFromCommit函数支持不同仓库类型
                async function fetchFileFromCommit(commitSha, repoConfig) {
                    const fileName = 'markdown_files.json';

                    try {
                        let content = '';

                        // 根据仓库类型选择不同的API调用方式
                        switch (repoConfig.type) {
                            case 'github':
                                content = await fetchGitHubFileFromCommit(commitSha, fileName, repoConfig);
                                break;
                            case 'gitee':
                                content = await fetchGiteeFileFromCommit(commitSha, fileName, repoConfig);
                                break;
                            case 'gitea':
                                content = await fetchGiteaFileFromCommit(commitSha, fileName, repoConfig);
                                break;
                            case 'gitlab':
                                content = await fetchGitLabFileFromCommit(commitSha, fileName, repoConfig);
                                break;
                            case 'gitcode':
                                content = await fetchGitcodeFileFromCommit(commitSha, fileName, repoConfig);
                                break;
                            default:
                                throw new Error(`不支持的仓库类型: ${repoConfig.type}`);
                        }

                        // 如果仓库配置了加密，尝试解密
                        if (isEncryptedData(content)) {
                            try {
                                return decryptData(content);
                            } catch (error) {
                                throw new Error('解密失败，请确保使用正确的密码');
                            }
                        }

                        return content;
                    } catch (error) {
                        throw new Error(`获取文件内容失败: ${error.message}`);
                    }
                }

                // GitHub获取文件内容
                async function fetchGitHubFileFromCommit(commitSha, fileName, repoConfig) {
                    const apiUrl = `https://api.github.com/repos/${repoConfig.path}/contents/${fileName}?ref=${commitSha}`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${repoConfig.token}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`GitHub API错误: ${response.status}`);
                    }

                    return await response.text();
                }
                function isEncryptedData(content) {
                    // 加密数据通常具有特定的模式：
                    // 1. 包含特定的加密标识
                    // 2. 具有特定的格式（如CryptoJS的特定格式）
                    // 3. 无法解析为JSON

                    // 检查是否包含CryptoJS的特定标识
                    if (content.includes('U2FsdGVkX1')) {
                        return true;
                    }

                    // 检查是否是有效的JSON
                    try {
                        JSON.parse(content);
                        return false; // 能解析为JSON，不是加密数据
                    } catch (e) {
                        // 无法解析为JSON，可能是加密数据
                        return true;
                    }
                }
                // Gitee获取文件内容
                async function fetchGiteeFileFromCommit(commitSha, fileName, repoConfig) {
                    const apiUrl = `https://gitee.com/api/v5/repos/${repoConfig.path}/contents/${fileName}?ref=${commitSha}`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `Bearer ${repoConfig.token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Gitee API错误: ${response.status}`);
                    }

                    const fileData = await response.json();
                    return atob(fileData.content);
                }

                // Gitea获取文件内容
                async function fetchGiteaFileFromCommit(commitSha, fileName, repoConfig) {
                    const baseUrl = repoConfig.url || 'https://gitea.com';
                    const apiUrl = `${baseUrl}/api/v1/repos/${repoConfig.path}/contents/${fileName}?ref=${commitSha}`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${repoConfig.token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Gitea API错误: ${response.status}`);
                    }

                    const fileData = await response.json();
                    return atob(fileData.content);
                }

                // GitLab获取文件内容
                async function fetchGitLabFileFromCommit(commitSha, fileName, repoConfig) {
                    const apiUrl = `https://gitlab.com/api/v4/projects/${encodeURIComponent(repoConfig.path)}/repository/files/${encodeURIComponent(fileName)}/raw?ref=${commitSha}`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'PRIVATE-TOKEN': repoConfig.token
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`GitLab API错误: ${response.status}`);
                    }

                    return await response.text();
                }

                // Gitcode获取文件内容（假设API类似GitHub）
                async function fetchGitcodeFileFromCommit(commitSha, fileName, repoConfig) {
                    const apiUrl = `https://gitcode.net/api/v1/repos/${repoConfig.path}/contents/${fileName}?ref=${commitSha}`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${repoConfig.token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Gitcode API错误: ${response.status}`);
                    }

                    const fileData = await response.json();
                    return atob(fileData.content);
                }

                // 渲染远程历史列表
                function renderRemoteHistoryList(commits) {
                    const historyList = document.getElementById('remoteHistoryList');
                    historyList.innerHTML = '';

                    if (commits.length === 0) {
                        historyList.innerHTML = '<div class="empty-state">暂无历史版本</div>';
                        return;
                    }

                    commits.forEach(commit => {
                        const commitItem = document.createElement('div');
                        commitItem.className = 'repo-item';
                        commitItem.dataset.sha = commit.sha;

                        commitItem.innerHTML = `
      <div class="history-header">
        <input type="radio" name="remoteHistoryVersion" id="commit_${commit.sha}">
        <label for="commit_${commit.sha}">
          <span class="commit-date">${commit.date}</span>
        </label>
      </div>
      <div class="history-message">-${commit.message}</div>
    `;

                        historyList.appendChild(commitItem);
                    });
                }

                // GitHub获取提交历史
                async function fetchGitHubCommits(repoConfig) {
                    const apiUrl = `https://api.github.com/repos/${repoConfig.path}/commits?path=markdown_files.json`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `token ${repoConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`GitHub API错误: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.map(commit => ({
                        sha: commit.sha,
                        message: commit.commit.message,
                        author: commit.commit.author.name,
                        date: new Date(commit.commit.author.date).toLocaleString()
                    }));
                }

                // Gitee获取提交历史
                async function fetchGiteeCommits(repoConfig) {
                    const apiUrl = `https://gitee.com/api/v5/repos/${repoConfig.path}/commits?path=markdown_files.json`;

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `Bearer ${repoConfig.token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Gitee API错误: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.map(commit => ({
                        sha: commit.sha,
                        message: commit.commit.message,
                        author: commit.commit.author.name,
                        date: new Date(commit.commit.author.date).toLocaleString()
                    }));
                }



                
                // 恢复历史版本
                document.getElementById('restoreVersion').addEventListener('click', function () {
                    // 检查当前激活的标签页
                    const activeTab = document.querySelector('#historyModal .tab.active').dataset.tab;

                    if (activeTab === 'local') {
                        // 恢复本地历史版本
                        const selectedVersion = document.querySelector('#localHistoryList input[name="historyVersion"]:checked');
                        if (!selectedVersion) {
                            alert('请选择一个历史版本');
                            return;
                        }

                        const fileId = document.getElementById('localHistoryFileSelect').value;
                        const versionIndex = selectedVersion.closest('.history-item').dataset.index;

                        restoreLocalVersion(fileId, versionIndex);
                    } else if (activeTab === 'remote') {
                        // 恢复远程历史版本
                        const selectedCommit = document.querySelector('#remoteHistoryList input[name="remoteHistoryVersion"]:checked');
                        if (!selectedCommit) {
                            alert('请选择一个历史版本');
                            return;
                        }

                        const commitSha = selectedCommit.closest('.history-item').dataset.sha;
                        const repoIndex = document.getElementById('remoteHistoryRepoSelect').value;

                        restoreRemoteVersion(commitSha, repoIndex);
                    }
                });
                // 恢复远程历史版本
                async function restoreRemoteVersion(commitSha, repoIndex) {
                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');
                    const repo = config.repositories[repoIndex];

                    try {
                        // 获取该提交对应的文件内容
                        const fileContent = await fetchFileFromCommit(commitSha, repo);

                        // 解析文件内容
                        const jsonData = JSON.parse(fileContent);

                        if (!jsonData.files || !Array.isArray(jsonData.files)) {
                            throw new Error('无效的历史数据格式');
                        }

                        // 更新本地文件系统
                        files = jsonData.files;
                        saveFiles();

                        // 刷新界面
                        renderFileList();
                        if (files.length > 0) {
                            openFile(files[0].id);
                        }

                        alert('版本恢复成功');
                        document.getElementById('historyModal').style.display = 'none';
                    } catch (error) {
                        alert(`恢复失败: ${error.message}`);
                    }
                }
                // 导出配置
                document.getElementById('exportConfigBtn').addEventListener('click', function () {
                    const blob = new Blob([JSON.stringify(appConfig, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'md_editor_config.json';
                    document.body.appendChild(a);
                    a.click();

                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                });

                // 导入配置
                document.getElementById('configImport').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();

                        reader.onload = function (event) {
                            try {
                                const config = JSON.parse(event.target.result);
                                appConfig = config;
                                applyConfig();
                                saveConfig();
                                alert('配置导入成功！');
                            } catch (error) {
                                alert('配置文件格式错误');
                            }
                        };

                        reader.readAsText(file);
                    }
                });

                // 导入类型切换
                document.getElementById('importType').addEventListener('change', function () {
                    const type = this.value;
                    document.getElementById('fileImportSection').style.display =
                        type === 'file' ? 'block' : 'none';
                    document.getElementById('gitImportSection').style.display =
                        type === 'git' ? 'block' : 'none';
                    document.getElementById('textImportSection').style.display =
                        type === 'text' ? 'block' : 'none';
                    document.getElementById('filesImportSection').style.display =
                        type === 'files' ? 'block' : 'none';
                    document.getElementById('folderImportSection').style.display =
                        type === 'folder' ? 'block' : 'none';
                    document.getElementById('zipImportSection').style.display =
                        type === 'zip' ? 'block' : 'none';
                    document.getElementById('jsonImportSection').style.display =
                        type === 'json' ? 'block' : 'none';
                });

                // 导出类型切换
                document.getElementById('exportType').addEventListener('change', function () {
                    const type = this.value;
                    document.getElementById('singleExportSection').style.display =
                        type === 'single' ? 'block' : 'none';
                    document.getElementById('batchExportSection').style.display =
                        type === 'batch' ? 'block' : 'none';
                    document.getElementById('gitExportSection').style.display =
                        type === 'git' ? 'block' : 'none';
                });

                // 文件导入处理
                document.getElementById('fileInput').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        importFile(e.target.files[0]);
                        dataModal.style.display = 'none';
                    }
                });

                // 确认导入
                document.getElementById('confirmData').addEventListener('click', function () {
                    const activeTab = document.querySelector('.tab-content.active').id;
                    if (activeTab === 'importTab') {
                        const type = document.getElementById('importType').value;

                        switch (type) {
                            case 'file':
                                const fileInput = document.getElementById('fileInput');
                                if (fileInput.files.length > 0) {
                                    importFile(fileInput.files[0]);
                                    dataModal.style.display = 'none';
                                } else {
                                    alert('请选择要导入的文件');
                                }
                                break;
                            case 'files':
                                importFilesFromFiles(importData.files);
                                break;
                            case 'folder':
                                importFilesFromFolder(importData.files);
                                break;
                            case 'zip':
                                importFilesFromZip(importData.files);
                                break;
                            case 'json':
                                importFilesFromJson(importData.files);
                                break;
                            case 'text':
                                const content = document.getElementById('textImportContent').value;
                                if (content.trim() !== '') {
                                    const fileName = prompt('请输入文件名', '导入的文档.md');
                                    if (fileName) {
                                        createNewFile(fileName, content);
                                        dataModal.style.display = 'none';
                                    }
                                } else {
                                    alert('请输入要导入的内容');
                                }
                                break;
                            case 'git':
                                alert('正在开发中...');
                                break;
                        }

                    } else if (activeTab === 'exportTab') {
                        const type = document.getElementById('exportType').value;

                        if (type === 'single') {
                            exportFile();
                            dataModal.style.display = 'none';
                        } else if (type === 'batch') {
                            const format = document.getElementById('batchExportFormat').value;

                            if (format === 'zip') {
                                exportAllFilesAsZip();
                            } else if (format === 'json') {
                                exportAllFilesAsJson();
                            }
                            dataModal.style.display = 'none';
                        } else if (type === 'git') {
                            alert('导出到Git仓库功能需要后端支持，当前为演示模式');
                        }
                    }

                    // 关闭模态框
                    document.getElementById('dataModal').style.display = 'none';
                    // 重置导入数据
                    importData = { type: null, files: null, content: null };
                });
                // 修改导入函数，使用确认按钮触发
                function importFilesFromFolder(files) {
                    const status = document.createElement('div');
                    status.textContent = `导入文件中... (0/${files.length})`;
                    document.body.appendChild(status);

                    let importedCount = 0;

                    Array.from(files).forEach(file => {
                        if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                            const reader = new FileReader();

                            reader.onload = function (e) {
                                const content = e.target.result;
                                createNewFile(file.name, content);
                                importedCount++;
                                status.textContent = `导入文件中... (${importedCount}/${files.length})`;

                                if (importedCount === files.length) {
                                    status.textContent = `导入完成! 成功导入 ${importedCount} 个文件`;
                                    setTimeout(() => status.remove(), 3000);
                                }
                            };

                            reader.readAsText(file);
                        }
                    });
                }

                // ZIP导入函数
                async function importFilesFromZip(zipFile) {
                    const status = document.createElement('div');
                    status.textContent = '解析ZIP文件中...';
                    document.body.appendChild(status);

                    try {
                        // 确保JSZip已加载
                        await loadJSZip();

                        const zip = new JSZip();
                        const content = await zip.loadAsync(zipFile);

                        status.textContent = '导入文件中...';
                        let importedCount = 0;
                        let totalFiles = 0;

                        // 计算总文件数
                        zip.forEach((relativePath, file) => {
                            if (!file.dir && (relativePath.endsWith('.md') || relativePath.endsWith('.markdown'))) {
                                totalFiles++;
                            }
                        });

                        // 导入文件
                        await Promise.all(
                            Object.keys(content.files).map(async (relativePath) => {
                                const file = content.files[relativePath];
                                if (!file.dir && (relativePath.endsWith('.md') || relativePath.endsWith('.markdown'))) {
                                    const content = await file.async('string');
                                    const fileName = relativePath.split('/').pop();
                                    createNewFile(fileName, content);
                                    importedCount++;
                                    status.textContent = `导入文件中... (${importedCount}/${totalFiles})`;
                                }
                            })
                        );

                        status.textContent = `导入完成! 成功导入 ${importedCount} 个文件`;
                        setTimeout(() => status.remove(), 3000);
                    } catch (error) {
                        status.textContent = `导入失败: ${error.message}`;
                        status.style.color = 'red';
                    }
                }

                // JSON导入函数
                async function importFilesFromJson(jsonFile) {
                    const status = document.createElement('div');
                    status.textContent = '解析JSON文件中...';
                    document.body.appendChild(status);

                    const reader = new FileReader();

                    reader.onload = async function (e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);

                            if (jsonData.files && Array.isArray(jsonData.files)) {
                                status.textContent = `导入文件中... (0/${jsonData.files.length})`;

                                let importedCount = 0;
                                for (const fileData of jsonData.files) {
                                    createNewFile(fileData.name, fileData.content);
                                    importedCount++;
                                    status.textContent = `导入文件中... (${importedCount}/${jsonData.files.length})`;
                                }

                                status.textContent = `导入完成! 成功导入 ${importedCount} 个文件`;
                                setTimeout(() => status.remove(), 3000);
                            } else {
                                throw new Error('无效的JSON格式');
                            }
                        } catch (error) {
                            status.textContent = `导入失败: ${error.message}`;
                            status.style.color = 'red';
                        }
                    };

                    reader.readAsText(jsonFile);
                }
                // 文件导入函数
                function importFilesFromFiles(files) {
                    const status = document.createElement('div');
                    status.textContent = `导入文件中... (0/${files.length})`;
                    document.body.appendChild(status);

                    let importedCount = 0;

                    Array.from(files).forEach(file => {
                        if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                            const reader = new FileReader();

                            reader.onload = function (e) {
                                const content = e.target.result;
                                createNewFile(file.name, content);
                                importedCount++;
                                status.textContent = `导入文件中... (${importedCount}/${files.length})`;

                                if (importedCount === files.length) {
                                    status.textContent = `导入完成! 成功导入 ${importedCount} 个文件`;
                                    setTimeout(() => status.remove(), 3000);
                                }
                            };

                            reader.readAsText(file);
                        }
                    });
                }


                // 点击模态框外部关闭
                window.addEventListener('click', function (event) {
                    if (event.target.classList.contains('modal')) {
                        event.target.style.display = 'none';
                    }
                });



                // 初始化配置
                function initImageHostConfig() {
                    const savedConfig = localStorage.getItem('imageHostConfig');
                    if (savedConfig) {
                        Object.assign(imageHostConfig, JSON.parse(savedConfig));
                    }
                    renderImageHostConfig();
                }

                // 渲染图床配置到界面
                function renderImageHostConfig() {
                    // 设置默认服务
                    document.getElementById('imageHostService').value = imageHostConfig.defaultService;

                    // 渲染各个服务的配置
                    Object.keys(imageHostConfig.services).forEach(service => {
                        const config = imageHostConfig.services[service];
                        if (service === 'github') {
                            document.getElementById('githubUsername').value = config.username;
                            document.getElementById('githubRepo').value = config.repo;
                            document.getElementById('githubBranch').value = config.branch;
                            document.getElementById('githubPath').value = config.path;
                            document.getElementById('githubToken').value = config.token;
                            document.getElementById('githubDomain').value = config.customDomain;
                        } else if (service === 'gitee') {
                            document.getElementById('giteeUsername').value = config.username;
                            document.getElementById('giteeRepo').value = config.repo;
                            document.getElementById('giteeBranch').value = config.branch;
                            document.getElementById('giteePath').value = config.path;
                            document.getElementById('giteeToken').value = config.token;
                            document.getElementById('giteeDomain').value = config.customDomain;
                        } else if (service === 'custom') {
                            document.getElementById('customApiUrl').value = config.apiUrl;
                            document.getElementById('customUploadPath').value = config.uploadPath;
                            document.getElementById('customApiKey').value = config.apiKey;
                            document.getElementById('customDomain').value = config.customDomain;
                        }
                    });

                    // 更新服务选择显示
                    updateServiceDisplay();
                }

                // 保存图床配置
                function saveImageHostConfig() {
                    imageHostConfig.defaultService = document.getElementById('imageHostService').value;

                    // 保存各个服务的配置
                    imageHostConfig.services.github = {
                        username: document.getElementById('githubUsername').value,
                        repo: document.getElementById('githubRepo').value,
                        branch: document.getElementById('githubBranch').value,
                        path: document.getElementById('githubPath').value,
                        token: document.getElementById('githubToken').value,
                        customDomain: document.getElementById('githubDomain').value,
                        enabled: true
                    };

                    imageHostConfig.services.gitee = {
                        username: document.getElementById('giteeUsername').value,
                        repo: document.getElementById('giteeRepo').value,
                        branch: document.getElementById('giteeBranch').value,
                        path: document.getElementById('giteePath').value,
                        token: document.getElementById('giteeToken').value,
                        customDomain: document.getElementById('giteeDomain').value,
                        enabled: true
                    };

                    imageHostConfig.services.custom = {
                        apiUrl: document.getElementById('customApiUrl').value,
                        uploadPath: document.getElementById('customUploadPath').value,
                        apiKey: document.getElementById('customApiKey').value,
                        customDomain: document.getElementById('customDomain').value,
                        enabled: document.getElementById('customApiUrl').value !== ''
                    };

                    localStorage.setItem('imageHostConfig', JSON.stringify(imageHostConfig));
                    return imageHostConfig;
                }

                // 上传图片到图床
                async function uploadImageToImageHost(file, alt) {
                    const status = document.createElement('div');
                    status.textContent = '上传中...';
                    document.getElementById('imageTab').appendChild(status);

                    try {
                        const config = imageHostConfig.services[imageHostConfig.defaultService];

                        if (!config.enabled) {
                            throw new Error('当前图床服务未启用');
                        }

                        // 生成文件名
                        const timestamp = new Date().getTime();
                        const fileName = file.name.replace(/\.[^/.]+$/, "").replace(/\s+/g, '_');
                        const fileExtension = file.name.split('.').pop();
                        const finalFileName = `${fileName}_${timestamp}.${fileExtension}`;

                        let imageUrl = '';

                        // 根据服务类型选择上传方式
                        if (imageHostConfig.defaultService === 'github') {
                            imageUrl = await uploadToGitHub(file, finalFileName, config);
                        } else if (imageHostConfig.defaultService === 'gitee') {
                            imageUrl = await uploadToGitee(file, finalFileName, config);
                        } else if (imageHostConfig.defaultService === 'custom') {
                            imageUrl = await uploadToCustom(file, finalFileName, config);
                        }

                        status.textContent = '上传成功!';
                        status.style.color = 'green';

                        // 插入Markdown
                        const markdown = `![${alt}](${imageUrl})`;
                        insertAtCursor(markdown);

                        // 关闭模态框
                        setTimeout(() => {
                            document.getElementById('insertModal').style.display = 'none';
                        }, 1000);

                    } catch (error) {
                        status.textContent = `上传失败: ${error.message}`;
                        status.style.color = 'red';
                    }
                }

                // 上传到GitHub
                async function uploadToGitHub(file, fileName, config) {
                    const baseUrl = 'https://api.github.com';
                    const apiUrl = `${baseUrl}/repos/${config.username}/${config.repo}/contents/${config.path}/${fileName}`;

                    // 读取文件内容并转换为base64
                    const fileContent = await readFileAsBase64(file);

                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Upload image: ${fileName}`,
                            content: fileContent.split(',')[1], // 移除data:image/...前缀
                            branch: config.branch
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`GitHub API错误: ${response.status}`);
                    }

                    const result = await response.json();
                    if (config.customDomain.length > 1) {
                        return config.customDomain += `/${fileName}`;;
                    } else {
                        return result.content.download_url;
                    }
                }

                // 上传到Gitee
                async function uploadToGitee(file, fileName, config) {
                    const baseUrl = 'https://gitee.com/api/v5';
                    const apiUrl = `${baseUrl}/repos/${config.username}/${config.repo}/contents/${config.path}/${fileName}`;

                    const fileContent = await readFileAsBase64(file);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            access_token: config.token,
                            content: fileContent.split(',')[1],
                            message: `Upload image: ${fileName}`,
                            branch: config.branch
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Gitee API错误: ${response.status}`);
                    }

                    const result = await response.json();
                    if (config.customDomain.length > 1) {
                        return config.customDomain += `/${fileName}`;;
                    } else {
                        return result.content.download_url;
                    }
                }

                // 上传到自定义图床
                async function uploadToCustom(file, fileName, config) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('fileName', fileName);

                    if (config.apiKey) {
                        formData.append('apiKey', config.apiKey);
                    }

                    const response = await fetch(config.apiUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`自定义图床错误: ${response.status}`);
                    }

                    const result = await response.json();
                    if (config.customDomain.length > 1) {
                        return config.customDomain += `/${fileName}`;;
                    } else {
                        return result.url || result.data.url;
                    }
                }

                // 将文件读取为Base64
                function readFileAsBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }

                // 设置默认图床
                function setDefaultImageHost(service) {
                    imageHostConfig.defaultService = service;
                    localStorage.setItem('imageHostConfig', JSON.stringify(imageHostConfig));
                    updateServiceDisplay();
                }

                // 更新服务选择显示
                function updateServiceDisplay() {
                    const serviceSelect = document.getElementById('imageHostService');
                    serviceSelect.value = imageHostConfig.defaultService;

                    // 显示当前默认服务
                    const defaultIndicator = document.getElementById('defaultIndicator') ||
                        document.createElement('span');
                    defaultIndicator.id = 'defaultIndicator';
                    defaultIndicator.textContent = '（默认）';
                    defaultIndicator.style.color = 'green';
                    defaultIndicator.style.marginLeft = '5px';

                    // 移除之前的指示器
                    document.querySelectorAll('#defaultIndicator').forEach(el => el.remove());

                    // 在当前选中的服务后添加指示器
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    selectedOption.textContent += '（默认）';
                }


                // 添加设置默认图床按钮事件
                document.getElementById('setDefaultImageHostBtn').addEventListener('click', function () {
                    const service = document.getElementById('imageHostService').value;
                    setDefaultImageHost(service);
                    alert(`已将${service}设置为默认图床`);
                });

                // 修改登录处理逻辑
                // document.getElementById('loginForm').addEventListener('submit', function (e) {
                //     console.log("fedgdfgdfgdfd");

                //     const password = document.getElementById('password').value;
                //     const storedPasswordHash = localStorage.getItem('passwordHash');

                //     // 无论密码是否正确都进入主页
                //     authContainer.style.display = 'none';
                //     editorContainer.style.display = 'block';

                //     // 初始化应用
                //     initApplication(password);
                // });

                // 修改初始化应用函数
                function initApplication(password) {
                    // 尝试解密数据
                    try {
                        const storedPasswordHash = localStorage.getItem('passwordHash');

                        if (storedPasswordHash && verifyPassword(password, storedPasswordHash)) {
                            // 密码正确，正常加载数据
                            loadDecryptedData(password);
                            showStatusMessage('密码正确，数据已解密');
                        } else {
                            // 密码错误，显示加密数据或提示
                            showEncryptedData();
                            showStatusMessage('密码错误，显示加密数据');
                        }
                    } catch (error) {
                        // 处理错误情况
                        console.error('初始化失败:', error);
                        showStatusMessage('初始化失败，请检查数据');
                    }
                }

                // 加载解密数据
                async function loadDecryptedData(password) {
                    const encryptedData = localStorage.getItem('encryptedFiles');
                    if (!encryptedData) {
                        // 没有加密数据，正常加载
                        initFileSystem();
                        return;
                    }

                    try {
                        const encryptionKey = await deriveKeyFromPassword(password);
                        const decryptedData = await decryptContent(encryptedData, encryptionKey);

                        // 解析解密后的数据
                        const files = JSON.parse(decryptedData);
                        localStorage.setItem('mdEditorFiles', JSON.stringify(files));

                        // 初始化文件系统
                        initFileSystem();
                    } catch (error) {
                        console.error('解密失败:', error);
                        showStatusMessage('解密失败，显示加密数据');
                        showEncryptedData();
                    }
                }

                // 显示加密数据
                function showEncryptedData() {
                    const encryptedData = localStorage.getItem('encryptedFiles');

                    if (encryptedData) {
                        // 创建加密数据视图
                        const encryptedView = document.createElement('div');
                        encryptedView.id = 'encryptedView';
                        encryptedView.innerHTML = `
      <div style="text-align: center; padding: 50px;">
        <i class="fas fa-lock" style="font-size: 48px; color: #e74c3c;"></i>
        <h2>数据已加密</h2>
        <p>请输入正确密码查看内容</p>
        <button id="retryAuthBtn" class="editor-btn">重新输入密码</button>
      </div>
    `;

                        document.getElementById('editorContainer').appendChild(encryptedView);

                        // 添加重新输入密码按钮事件
                        document.getElementById('retryAuthBtn').addEventListener('click', function () {
                            encryptedView.remove();
                            authContainer.style.display = 'flex';
                        });
                    } else {
                        // 没有加密数据，正常加载
                        initFileSystem();
                    }
                }

                // 解密内容
                async function decryptContent(encryptedContent, key) {
                    // Base64解码
                    const decodedData = atob(encryptedContent);
                    const dataArray = new Uint8Array(decodedData.length);

                    for (let i = 0; i < decodedData.length; i++) {
                        dataArray[i] = decodedData.charCodeAt(i);
                    }

                    // 提取IV和加密数据
                    const iv = dataArray.slice(0, 12);
                    const encryptedData = dataArray.slice(12);

                    // 解密
                    const algorithm = { name: 'AES-GCM', iv };
                    const decrypted = await crypto.subtle.decrypt(algorithm, key, encryptedData);

                    return new TextDecoder().decode(decrypted);
                }



                // 同步所有文档到仓库
                async function syncAllFilesToRepositories() {
                    const config = JSON.parse(localStorage.getItem('multiGitConfig') || '{}');
                    if (!config.repositories || config.repositories.length === 0) {
                        showStatusMessage('未配置仓库，无法同步');
                        return;
                    }

                    // 更新同步状态
                    syncStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>同步中...</span>';
                    syncStatus.classList.remove('synced', 'error');

                    try {
                        // 获取所有文件数据
                        const allFiles = JSON.parse(localStorage.getItem('mdEditorFiles') || '[]');

                        // 创建包含所有文件的JSON对象
                        const jsonData = {
                            version: 1,
                            exportedAt: new Date().toISOString(),
                            files: allFiles
                        };

                        const jsonString = JSON.stringify(jsonData, null, 2);

                        // 使用forEach循环顺序执行同步
                        const results = [];
                        let successCount = 0;
                        let errorCount = 0;

                        for (const repo of config.repositories) {
                            try {
                                // 更新状态显示当前同步的仓库
                                syncStatus.innerHTML = `<i class="fas fa-sync fa-spin"></i> <span>同步到 ${repo.name} (${successCount + errorCount + 1}/${config.repositories.length})</span>`;

                                // 同步到当前仓库
                                await syncJsonToRepository(jsonString, repo);
                                results.push({ status: 'fulfilled', value: repo.name });
                                successCount++;
                            } catch (error) {
                                results.push({ status: 'rejected', reason: error.message });
                                errorCount++;

                                // 更新状态显示错误
                                syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>${repo.name} 同步失败: ${error.message}</span>`;
                                syncStatus.classList.add('error');
                                console.log(`${error.message}`);

                                // 等待1秒再继续下一个仓库
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }

                        // 更新最终同步状态
                        if (errorCount === 0) {
                            syncStatus.innerHTML = `<i class="fas fa-check-circle"></i> <span>同步成功 (${successCount}/${config.repositories.length})</span>`;
                            syncStatus.classList.add('synced');
                        } else {
                            syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>部分同步失败 (${successCount}成功, ${errorCount}失败)</span>`;
                            syncStatus.classList.add('error');
                        }
                    } catch (error) {
                        syncStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>同步失败: ${error.message}</span>`;
                        syncStatus.classList.add('error');
                    }
                }

                // 同步JSON数据到仓库
                async function syncJsonToRepository(jsonData, repoConfig) {
                    const fileName = 'markdown_files.json';
                    let content = jsonData;

                    console.log("------1" + repoConfig.type);
                    // 如果仓库配置了加密，对内容进行加密
                    if (repoConfig.encrypt) {
                        content = encryptData(jsonData);
                    }
                    console.log("------2" + repoConfig.encrypt);

                    // 根据仓库类型选择同步方法
                    switch (repoConfig.type) {
                        case 'github':
                            return syncToGitHub(fileName, content, repoConfig);
                        case 'gitee':
                            return syncToGitee(fileName, content, repoConfig);
                        case 'gitea':
                            return syncToGitea(fileName, content, repoConfig);
                        case 'gitlab':
                            return syncToGitLab(fileName, content, repoConfig);
                        default:
                            throw new Error(`不支持的仓库类型: ${repoConfig.type}`);
                    }
                }

                // GitHub同步实现
                async function syncToGitHub(fileName, content, config) {
                    const apiUrl = `https://api.github.com/repos/${config.path}/contents/${fileName}`;

                    // 获取文件SHA（如果存在）
                    let sha = '';
                    try {
                        const existingFile = await fetch(apiUrl, {
                            headers: { 'Authorization': `token ${config.token}` }
                        });

                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                        }
                    } catch (error) {
                        // 文件不存在，继续创建
                    }

                    // 创建或更新文件
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: commitMessage,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha,
                            branch: config.branch || 'master'
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`GitHub同步失败: ${errorData.message}`);
                    }
                }

                // Gitee同步实现
                async function syncToGitee(fileName, content, config) {
                    const apiUrl = `https://gitee.com/api/v5/repos/${config.path}/contents/${fileName}`;

                    // 获取文件SHA（如果存在）
                    let sha = '';
                    try {
                        const existingFile = await fetch(`${apiUrl}?ref=${config.branch || 'master'}`);

                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                        }
                    } catch (error) {
                        // 文件不存在，继续创建
                    }

                    // 创建或更新文件
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_token: config.token,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha,
                            branch: config.branch || 'master',
                            message: commitMessage
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Gitee同步失败: ${errorData.message}`);
                    }
                }

                // 同步到GitLab
                async function syncToGitLab(fileName, content, config) {
                    const apiUrl = `https://gitlab.com/api/v4/projects/${encodeURIComponent(config.path)}/repository/files/${encodeURIComponent(fileName)}`;

                    // 获取文件SHA（如果存在）
                    let sha = '';
                    try {
                        const existingFile = await fetch(`${apiUrl}?ref=${config.branch || 'master'}`, {
                            headers: { 'PRIVATE-TOKEN': config.token }
                        });

                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                        }
                    } catch (error) {
                        // 文件不存在，继续创建
                    }

                    // 创建或更新文件
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'PRIVATE-TOKEN': config.token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            branch: config.branch || 'master',
                            commit_message: commitMessage,
                            content: btoa(unescape(encodeURIComponent(content))),
                            encoding: 'base64',
                            sha: sha
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`GitLab同步失败: ${errorData.message}`);
                    }
                }

                // 同步到Gitea
                async function syncToGitea(fileName, content, config) {
                    const baseUrl = config.url || 'https://gitea.com';
                    const apiUrl = `${baseUrl}/api/v1/repos/${config.path}/contents/${fileName}`;

                    // 获取文件SHA（如果存在）
                    let sha = '';
                    try {
                        const existingFile = await fetch(`${apiUrl}?ref=${config.branch || 'master'}`, {
                            headers: { 'Authorization': `token ${config.token}` }
                        });

                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                        }
                    } catch (error) {
                        // 文件不存在，继续创建
                    }

                    // 创建或更新文件
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            branch: config.branch || 'master',
                            message: commitMessage,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Gitea同步失败: ${errorData.message}`);
                    }
                }

                // 同步到Gitcode（假设API类似GitHub）
                async function syncToGitcode(fileName, content, config) {
                    const apiUrl = `https://gitcode.net/api/v1/repos/${config.path}/contents/${fileName}`;

                    // 获取文件SHA（如果存在）
                    let sha = '';
                    try {
                        const existingFile = await fetch(apiUrl, {
                            headers: { 'Authorization': `token ${config.token}` }
                        });

                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                        }
                    } catch (error) {
                        // 文件不存在，继续创建
                    }

                    // 创建或更新文件
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: commitMessage,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: sha,
                            branch: config.branch || 'master'
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Gitcode同步失败: ${errorData.message}`);
                    }
                }
                // 存储导入数据
                let importData = {
                    type: null,
                    files: null,
                    content: null
                };

                // 文件选择事件 - 只保存数据，不执行导入
                document.getElementById('fileInput').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        importData.type = 'file';
                        importData.files = e.target.files;
                        showImportPreview();
                    }
                });

                // 文件夹选择事件
                document.getElementById('folderInput').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        importData.type = 'folder';
                        importData.files = e.target.files;
                        showImportPreview();
                    }
                });

                // ZIP文件选择事件
                document.getElementById('zipInput').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        importData.type = 'zip';
                        importData.files = e.target.files[0];
                        showImportPreview();
                    }
                });

                // JSON文件选择事件
                document.getElementById('jsonInput').addEventListener('change', function (e) {
                    if (e.target.files.length > 0) {
                        importData.type = 'json';
                        importData.files = e.target.files[0];
                        showImportPreview();
                    }
                });

                // 显示导入预览
                function showImportPreview() {
                    const preview = document.getElementById('importPreview');
                    const previewContent = document.getElementById('previewContent');
                    preview.style.display = 'block';

                    switch (importData.type) {
                        case 'file':
                            previewContent.innerHTML = `
        <p>导入类型: 文件</p>
        <p>文件数量: ${importData.files.length}</p>
        <p>第一个文件: ${importData.files[0].name}</p>
      `;
                            break;

                        case 'folder':
                            previewContent.innerHTML = `
        <p>导入类型: 文件夹</p>
        <p>文件数量: ${importData.files.length}</p>
        <p>包含文件: ${Array.from(importData.files).slice(0, 3).map(f => f.name).join(', ')}${importData.files.length > 3 ? '...' : ''}</p>
      `;
                            break;

                        case 'zip':
                            previewContent.innerHTML = `
        <p>导入类型: ZIP文件</p>
        <p>文件名: ${importData.files.name}</p>
        <p>文件大小: ${(importData.files.size / 1024).toFixed(2)} KB</p>
      `;
                            break;

                        case 'json':
                            // 预览JSON内容
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                try {
                                    const jsonData = JSON.parse(e.target.result);
                                    previewContent.innerHTML = `
            <p>导入类型: JSON文件</p>
            <p>文件名: ${importData.files.name}</p>
            <p>包含文件: ${jsonData.files ? jsonData.files.length : 0}</p>
            <p>导出时间: ${jsonData.exportedAt || '未知'}</p>
          `;
                                } catch (error) {
                                    previewContent.innerHTML = `<p class="error">无法解析JSON文件</p>`;
                                }
                            };
                            reader.readAsText(importData.files);
                            break;
                    }
                }

            });

            // 初始化管理器
            document.addEventListener('DOMContentLoaded', () => {
                const markdownManager = new MarkdownManager();
            });
        </script>
</body>

</html>